<div class="mx-auto max-w-6xl p-4 md:p-8">
  <header class="mb-6">
    <div class="flex items-center justify-between gap-3 flex-wrap">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900 dark:text-slate-100">Bio-Bench</h1>
        <p class="mt-1 text-slate-600 dark:text-slate-400 text-sm md:text-base">Laboratory Utilities & Reference Tools</p>
      </div>
    </div>
  </header>

  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
      .font-mono { font-family: 'JetBrains Mono', monospace; }

      /* Animation */
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .animate-enter { animation: fadeIn 0.4s ease-out forwards; }
  </style>

  <!-- Enforce Tailwind Config here too (safe to repeat or index.html handles it) -->
  <script>
    if (typeof window.tailwind === 'undefined') {
       window.tailwind = { config: { darkMode: 'class' } };
    }
  </script>

  <!-- Navigation Tabs -->
  <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
    <nav class="-mb-px flex space-x-6 overflow-x-auto scrollbar-hide" aria-label="Tabs" id="bb-tabs">
      <button class="bb-tab active border-indigo-500 text-indigo-600 dark:text-indigo-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-buffer">
        üß™ Buffer Mixer
      </button>
      <button class="bb-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-macro">
        üß¨ Macromolecules
      </button>
      <button class="bb-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-cryo">
        ‚ùÑÔ∏è Cryo-EM Suite
      </button>
      <button class="bb-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-utils">
        üìê Lab Utilities
      </button>
      <button class="bb-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-reactions">
        üß™ Master Mix
      </button>
      <button class="bb-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-purify">
        üßº Purification
      </button>
      <button class="bb-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-align">
        üß¨ BioAlign
      </button>
      <button class="bb-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-seq-viewer">
        üß¨ Sequence Viewer
      </button>
    </nav>
  </div>

  <!-- Tab Contents -->
  <div id="bb-content">

    <!-- BioAlign Pro -->
    <div id="tab-align" class="bb-pane hidden space-y-6">
        <div id="bioalign-root"></div>
    </div>

    <!-- Sequence Viewer -->
    <div id="tab-seq-viewer" class="bb-pane hidden space-y-6">
       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
          <h3 class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Sequence Viewer</h3>

          <!-- Input -->
          <div class="mb-4">
             <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sequence</label>
             <textarea id="sv-seq-input" rows="4" class="w-full p-2 border rounded-lg font-mono text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100 uppercase" placeholder="Paste sequence..."></textarea>
          </div>

          <!-- Controls -->
          <div class="flex flex-wrap items-end gap-3 mb-4 bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-800">
             <div>
                 <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Highlight Region (Start - End)</label>
                 <div class="flex gap-2">
                    <input type="number" id="sv-hl-start" class="w-20 p-1.5 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="1">
                    <input type="number" id="sv-hl-end" class="w-20 p-1.5 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="10">
                 </div>
             </div>
             <div class="flex items-center gap-2">
                 <input type="color" id="sv-hl-color" value="#fca5a5" class="w-6 h-6 p-0 border-0 rounded overflow-hidden cursor-pointer bg-transparent" title="Highlight Color">
                 <button id="sv-add-hl" class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded hover:bg-indigo-700">Add Region</button>
             </div>

             <!-- New Controls -->
             <div class="ml-4 pl-4 border-l border-gray-200 dark:border-gray-700">
                 <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Residues/Row</label>
                 <input type="number" id="sv-row-len" value="60" class="w-16 p-1.5 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
             </div>
             <div>
                 <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Color Mode</label>
                 <select id="sv-color-mode" class="p-1.5 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                     <option value="none">None</option>
                     <option value="type">Residue Type</option>
                     <option value="charge">Charge</option>
                     <option value="hydro">Hydrophobicity</option>
                 </select>
             </div>

             <div class="ml-auto flex items-center gap-2">
                 <label class="flex items-center gap-2 text-xs text-gray-700 dark:text-slate-300 cursor-pointer select-none">
                     <input type="checkbox" id="sv-show-feats" class="rounded text-indigo-600 focus:ring-indigo-500 dark:bg-slate-800 dark:border-gray-600">
                     Show Features
                 </label>
                 <button id="sv-clear-hl" class="text-xs border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 px-2 py-1.5 rounded hover:bg-gray-50 dark:hover:bg-slate-700">Clear All</button>
             </div>
          </div>

          <!-- Highlight List -->
          <div id="sv-hl-list" class="flex flex-wrap gap-2 mb-4 empty:hidden"></div>

          <!-- Features Panel (Expandable) -->
          <details id="sv-features-panel" class="mb-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-gray-700 rounded-lg hidden">
              <summary class="cursor-pointer p-2 text-xs font-semibold text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-slate-900/50 rounded-t-lg select-none">Detected Features</summary>
              <div class="flex justify-end px-2 pt-2">
                  <button id="sv-uncheck-all" class="text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">Uncheck All</button>
              </div>
              <div id="sv-features-list" class="p-2 text-xs grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                  <!-- Dynamic Checkboxes -->
              </div>
          </details>

          <!-- Output -->
          <div id="sv-output" class="font-mono text-sm overflow-x-auto whitespace-pre p-4 border rounded-lg bg-white dark:bg-slate-950 border-gray-200 dark:border-gray-700 text-slate-800 dark:text-slate-200 relative">
             <!-- Rendered sequence will go here -->
             <div class="text-gray-400 italic">Enter sequence above.</div>
          </div>

          <!-- Selection Stats -->
          <div id="sv-sel-stats" class="mb-2 hidden mt-2">
              <div class="flex flex-wrap gap-3 items-center text-xs bg-indigo-50 dark:bg-indigo-900/20 text-indigo-900 dark:text-indigo-200 p-2 rounded border border-indigo-100 dark:border-indigo-800">
                  <span class="font-bold">Selection:</span>
                  <span><span id="sv-sel-len">0</span> aa</span>
                  <span>MW: <span id="sv-sel-mw" class="font-mono">0.00</span> Da</span>
                  <span>Œµ: <span id="sv-sel-ext" class="font-mono">0</span></span>
                  <span>Net Charge: <span id="sv-sel-chg" class="font-mono">0.00</span></span>
              </div>
          </div>

          <!-- Residue Key -->
          <div id="sv-legend" class="mt-2 text-xs text-gray-500 dark:text-gray-400 empty:hidden"></div>
       </div>
    </div>

    <!-- Buffer Mixer -->
    <div id="tab-buffer" class="bb-pane block space-y-6">
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
        <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
             <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">Buffer Recipe Calculator</h3>
             <div class="flex items-center gap-2">
                 <select id="buffer-preset-sel" class="text-xs p-1.5 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                     <option value="">-- Load Preset --</option>
                     <option value="PBS_1x">PBS (1x)</option>
                     <option value="PBST_1x">PBST (0.1% Tween)</option>
                     <option value="TBS_1x">TBS (1x)</option>
                     <option value="TBST_1x">TBST (0.1% Tween)</option>
                     <option value="HBS_1x">HBS (HEPES Buffered Saline)</option>
                     <option value="TE_1x">TE Buffer (10:1)</option>
                     <option value="TAE_1x">TAE (1x)</option>
                 </select>
                 <button id="btn-import-json" class="text-xs bg-white dark:bg-slate-700 border border-gray-300 dark:border-gray-600 px-2 py-1.5 rounded hover:bg-gray-50 dark:hover:bg-slate-600 dark:text-slate-200">üìÇ Import JSON</button>
                 <input type="file" id="file-import-json" class="hidden" accept=".json">
                 <button id="btn-export-json" class="text-xs bg-white dark:bg-slate-700 border border-gray-300 dark:border-gray-600 px-2 py-1.5 rounded hover:bg-gray-50 dark:hover:bg-slate-600 dark:text-slate-200">üíæ Export JSON</button>
             </div>
        </div>

        <div class="space-y-4" id="buffer-rows">
           <!-- Dynamic Rows -->
        </div>

        <!-- pH Adjustment Helper -->
        <details class="bg-slate-50 dark:bg-slate-900/50 rounded-lg p-3 border border-slate-100 dark:border-slate-800 mt-2">
            <summary class="text-xs font-semibold text-gray-500 cursor-pointer hover:text-gray-700 dark:hover:text-gray-300">pH Adjustment Calculator</summary>
            <div class="mt-2 grid grid-cols-3 gap-2 items-end">
                <div>
                    <label class="block text-[10px] text-gray-400">Target pH</label>
                    <input type="number" id="ph-target" class="w-full p-1 border rounded text-xs bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100 border-gray-300 dark:border-gray-600" step="0.1" placeholder="7.4">
                </div>
                <div>
                    <label class="block text-[10px] text-gray-400">pKa</label>
                    <input type="number" id="ph-pka" class="w-full p-1 border rounded text-xs bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100 border-gray-300 dark:border-gray-600" step="0.1" placeholder="e.g. 7.5">
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 pb-1" id="ph-ratio-out">
                    Ratio (Base/Acid): --
                </div>
            </div>
        </details>

        <div class="flex gap-3 mt-4">
           <button id="add-component-btn" class="text-sm bg-white hover:bg-gray-50 dark:bg-slate-700 dark:hover:bg-slate-600 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-slate-100 px-3 py-2 rounded-lg">
             + Add Component
           </button>
        </div>

        <div class="mt-6 pt-4 border-t border-gray-100 dark:border-gray-700">
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                 <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Total Volume</label>
                 <div class="flex gap-2">
                    <input type="number" id="buffer-total-vol" value="1" class="w-full p-2 border rounded-lg bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100 border-gray-300 dark:border-gray-600">
                    <select id="buffer-total-unit" class="p-2 border rounded-lg bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100 border-gray-300 dark:border-gray-600">
                       <option value="L">L</option>
                       <option value="mL">mL</option>
                    </select>
                 </div>
              </div>
              <div class="flex items-end">
                 <div class="text-sm text-gray-500 dark:text-gray-400">
                    Calculations update automatically.
                 </div>
              </div>
           </div>
        </div>

        <div class="mt-6 bg-slate-50 dark:bg-slate-900/50 rounded-lg p-4 border border-slate-100 dark:border-slate-800">
            <div class="flex justify-between items-center mb-2">
                <h4 class="font-medium text-slate-900 dark:text-slate-100">Recipe Checklist</h4>
                <div class="flex gap-2">
                    <button id="btn-print-table" class="text-xs text-slate-600 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 border border-gray-300 dark:border-slate-600 px-2 py-1 rounded bg-white dark:bg-slate-800">
                        üñ®Ô∏è Print Table
                    </button>
                    <button id="btn-export-recipe" class="text-xs text-indigo-500 hover:text-indigo-700 dark:hover:text-indigo-400 border border-indigo-200 dark:border-slate-700 px-2 py-1 rounded">
                        üìã Export Markdown
                    </button>
                </div>
            </div>
            <ul id="buffer-recipe-list" class="space-y-2 text-sm text-slate-700 dark:text-slate-300">
               <li class="italic text-gray-400">Add components to generate recipe.</li>
            </ul>
        </div>
      </div>
    </div>

    <!-- Macromolecule Converter -->
    <div id="tab-macro" class="bb-pane hidden space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
         <!-- Protein Tool -->
         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Protein Concentration & Mods</h3>
            <div class="space-y-3">
               <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Protein Sequence / FASTA</label>
                  <textarea id="macro-prot-seq" rows="4" class="w-full p-2 border rounded-lg font-mono text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder=">Header\nMSTRSV... or just Sequence"></textarea>
                  <p class="text-[10px] text-gray-500 dark:text-gray-400 mt-1">Parses FASTA header if present. Calculates MW & Œµ automatically.</p>
               </div>
               <div class="grid grid-cols-2 gap-3">
                  <div>
                      <label class="block text-xs text-gray-500 dark:text-gray-400">MW (kDa)</label>
                      <input type="number" id="macro-prot-mw" step="0.1" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                       <input type="hidden" id="macro-prot-base-mw"> <!-- Hidden store for sequence-only MW -->
                  </div>
                  <div>
                      <label class="block text-xs text-gray-500 dark:text-gray-400">Œµ<sub>280</sub> (M‚Åª¬πcm‚Åª¬π)</label>
                      <input type="number" id="macro-prot-eps" step="10" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                  </div>
               </div>
               <!-- Extinction Variants -->
               <div class="flex gap-2 text-[10px] justify-end -mt-2 mb-2">
                   <span class="text-gray-400">Set Œµ:</span>
                   <button id="btn-eps-red" class="text-indigo-500 hover:underline" title="Reduced (No S-S)">Red: <span id="val-eps-red">--</span></button>
                   <span class="text-gray-300">|</span>
                   <button id="btn-eps-ox" class="text-indigo-500 hover:underline" title="Oxidized (All Cys as S-S)">Ox: <span id="val-eps-ox">--</span></button>
               </div>

               <!-- ADDED Abs 0.1% Field -->
               <div class="grid grid-cols-2 gap-3">
                  <div>
                      <label class="block text-xs text-gray-500 dark:text-gray-400">Abs 0.1% (=1 g/L)</label>
                      <input type="number" id="macro-prot-abs-percent" step="0.01" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="e.g. 1.0">
                  </div>
                  <div class="flex items-end text-xs text-gray-400 pb-2">
                      (Approx based on Œµ & MW)
                  </div>
               </div>

               <!-- Modifications Section -->
               <details class="group bg-slate-50 dark:bg-slate-900/50 rounded-lg p-3 border border-slate-100 dark:border-slate-800" open>
                   <summary class="text-xs font-semibold text-gray-600 dark:text-gray-400 cursor-pointer list-none flex items-center gap-2">
                       <span class="group-open:rotate-90 transition-transform">‚ñ∂</span>
                       Modifications & Glycosylation
                   </summary>
                   <div class="mt-3 space-y-2">
                       <div id="mod-list-container" class="space-y-2">
                           <!-- Dynamic Rows -->
                       </div>
                       <div class="flex gap-2">
                           <button id="btn-add-mod" class="text-xs bg-white dark:bg-slate-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-slate-200 px-2 py-1 rounded hover:bg-gray-50 dark:hover:bg-slate-600">+ Add Mod</button>
                       </div>
                       <div class="text-[10px] text-right text-indigo-500 pt-2 border-t border-gray-200 dark:border-gray-700" id="mod-total-display">
                           Mods: +0.00 kDa
                       </div>
                   </div>
               </details>

               <hr class="border-gray-100 dark:border-gray-700 my-2">
               <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Absorbance (A<sub>280</sub>)</label>
                  <input type="number" id="macro-prot-a280" step="0.01" placeholder="e.g. 0.5" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
               </div>
               <div class="grid grid-cols-2 gap-3 bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-lg">
                   <div>
                       <div class="text-xs text-indigo-600 dark:text-indigo-300 font-semibold">Conc (mg/mL)</div>
                       <input type="number" id="macro-prot-res-mgml-in" class="w-full bg-transparent border-0 border-b border-indigo-200 dark:border-indigo-700 text-lg font-mono text-slate-900 dark:text-slate-100 focus:ring-0 p-0" value="0.00">
                   </div>
                   <div>
                       <div class="text-xs text-indigo-600 dark:text-indigo-300 font-semibold">Conc (ŒºM)</div>
                       <div id="macro-prot-res-um" class="text-lg font-mono text-slate-900 dark:text-slate-100 pt-1">0.00</div>
                   </div>
               </div>
            </div>
         </div>

         <!-- Nucleic Acid Tool -->
         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Nucleic Acids</h3>
            <div class="space-y-3">
               <div>
                   <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Type</label>
                   <select id="macro-na-type" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                       <option value="dsDNA">dsDNA (double-stranded)</option>
                       <option value="ssDNA">ssDNA (single-stranded/primer)</option>
                       <option value="ssRNA">ssRNA</option>
                   </select>
               </div>
               <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sequence (Optional for simple conc)</label>
                  <textarea id="macro-na-seq" rows="2" class="w-full p-2 border rounded-lg font-mono text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="ATGC..."></textarea>
               </div>

               <div class="grid grid-cols-2 gap-3">
                   <div>
                       <label class="block text-xs text-gray-500 dark:text-gray-400">Length (bp or nt)</label>
                       <input type="number" id="macro-na-len" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                   </div>
                   <div>
                       <label class="block text-xs text-gray-500 dark:text-gray-400">Approx MW (Da)</label>
                       <input type="number" id="macro-na-mw" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-slate-700 border-gray-200 dark:border-gray-600 text-slate-900 dark:text-slate-100" readonly>
                   </div>
               </div>

               <div class="grid grid-cols-2 gap-3">
                   <div>
                       <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Conc (ng/ŒºL)</label>
                       <input type="number" id="macro-na-ngul" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                   </div>
                   <div>
                       <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Result (nM)</label>
                       <input type="number" id="macro-na-nm" class="w-full p-2 border rounded-lg bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800 text-slate-900 dark:text-slate-100" readonly>
                   </div>
               </div>

               <div id="macro-na-tm-box" class="hidden mt-3 pt-3 border-t border-gray-100 dark:border-gray-700">
                   <div class="text-sm font-medium text-gray-700 dark:text-gray-300">Melting Temp (T<sub>m</sub>)</div>
                   <div class="text-xs text-gray-500 dark:text-gray-400">Based on 2¬∞(A-T) + 4¬∞(G-C) rule (< 14bp) or Wallace rule.</div>
                   <div class="mt-1 text-lg font-mono text-slate-900 dark:text-slate-100"><span id="macro-na-tm">--</span> ¬∞C</div>
               </div>
            </div>
         </div>
      </div>
    </div>

    <!-- Cryo-EM Suite -->
    <div id="tab-cryo" class="bb-pane hidden space-y-6">
       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
          <h3 class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Cryo-EM Parameters</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
             <div class="space-y-4">
                 <div>
                     <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Raw Pixel Size (√Ö/px)</label>
                     <input type="number" id="cryo-pix" step="0.001" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="e.g. 0.83">
                 </div>
                 <div>
                     <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Box Size (px)</label>
                     <input type="number" id="cryo-box" step="2" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="e.g. 256">
                 </div>

                 <!-- Fourier Crop Inputs -->
                 <div class="pt-2 border-t border-gray-100 dark:border-gray-700">
                     <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Target / Fourier Crop Box</label>
                     <input type="number" id="cryo-fc-box" step="2" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="e.g. 128">
                     <div id="cryo-box-suggestion" class="text-xs text-indigo-500 mt-1 cursor-pointer hover:underline"></div>
                 </div>

                 <div>
                     <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Binning Factor</label>
                     <input type="number" id="cryo-bin" step="0.01" value="1" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                 </div>

                 <!-- Max Res Helper -->
                 <div class="pt-2 border-t border-gray-100 dark:border-gray-700">
                     <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Target Nyquist (√Ö)</label>
                     <input type="number" id="cryo-target-res" step="0.1" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="e.g. 3.5">
                     <p class="text-xs text-gray-400 mt-1">Updates crop box.</p>
                 </div>
             </div>

             <div class="col-span-2 bg-slate-50 dark:bg-slate-900/50 rounded-xl p-4 border border-slate-100 dark:border-slate-800">
                 <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">Comparison</h4>
                 <div class="overflow-x-auto">
                     <table class="w-full text-sm text-left">
                         <thead class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-100 dark:bg-slate-800">
                             <tr>
                                 <th class="px-4 py-2 rounded-l-lg">Parameter</th>
                                 <th class="px-4 py-2">Raw (Unbinned)</th>
                                 <th class="px-4 py-2 rounded-r-lg">Binned / Cropped</th>
                             </tr>
                         </thead>
                         <tbody class="text-slate-700 dark:text-slate-300">
                             <tr class="border-b border-gray-200 dark:border-gray-700">
                                 <td class="px-4 py-3 font-medium">Pixel Size</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-pix-raw">--</td>
                                 <td class="px-4 py-3 font-mono font-bold text-indigo-600 dark:text-indigo-400" id="cryo-res-pix-bin">--</td>
                             </tr>
                             <tr class="border-b border-gray-200 dark:border-gray-700">
                                 <td class="px-4 py-3 font-medium">Nyquist (Res Limit)</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-nyq-raw">--</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-nyq-bin">--</td>
                             </tr>
                             <tr class="border-b border-gray-200 dark:border-gray-700">
                                 <td class="px-4 py-3 font-medium">Box Size (px)</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-box-raw">--</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-box-bin">--</td>
                             </tr>
                             <tr>
                                 <td class="px-4 py-3 font-medium">Physical Box Width</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-phys-raw">--</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-phys-bin">--</td>
                             </tr>
                         </tbody>
                     </table>
                 </div>
             </div>
          </div>
       </div>
    </div>

    <!-- Lab Utilities -->
    <div id="tab-utils" class="bb-pane hidden space-y-6">
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

           <!-- Dilution Calc -->
           <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
               <h3 class="text-base font-semibold mb-3 text-slate-900 dark:text-slate-100">Dilution (M1V1 = M2V2)</h3>
               <div class="space-y-3 text-sm">
                   <div class="grid grid-cols-2 gap-2">
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Stock Conc (M1)</label>
                           <input type="number" id="util-dil-m1" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                       </div>
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Stock Vol (V1)</label>
                           <input type="number" id="util-dil-v1" class="w-full p-2 border rounded bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800 text-slate-900 dark:text-slate-100 font-semibold" placeholder="?" readonly>
                       </div>
                   </div>
                   <div class="flex justify-center text-gray-400">‚Üì</div>
                   <div class="grid grid-cols-2 gap-2">
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Target Conc (M2)</label>
                           <input type="number" id="util-dil-m2" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                       </div>
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Target Vol (V2)</label>
                           <input type="number" id="util-dil-v2" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                       </div>
                   </div>
                   <div id="util-dil-res" class="p-2 bg-slate-50 dark:bg-slate-700 rounded text-xs text-center text-slate-700 dark:text-slate-300">
                       Enter M1, M2, V2 to calculate V1.
                   </div>
               </div>
           </div>

           <!-- Molarity Calc -->
           <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
               <h3 class="text-base font-semibold mb-3 text-slate-900 dark:text-slate-100">Molarity (Mass/Vol/MW)</h3>
               <div class="space-y-3 text-sm">
                   <!-- Updated to Reactive Solve-For Model -->
                   <div>
                       <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Solve For</label>
                       <select id="util-mol-solve" class="w-full p-2 border rounded bg-gray-50 dark:bg-slate-700 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                           <option value="mass">Mass (g)</option>
                           <option value="conc">Concentration (M)</option>
                           <option value="vol">Volume (L)</option>
                           <option value="mw">MW (g/mol)</option>
                       </select>
                   </div>
                   <hr class="border-gray-100 dark:border-gray-700">
                   <div>
                       <label class="block text-xs text-gray-500 dark:text-gray-400">MW (g/mol)</label>
                       <input type="number" id="util-mol-mw" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                   </div>
                   <div class="grid grid-cols-2 gap-2">
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Volume</label>
                           <div class="flex gap-1">
                               <input type="number" id="util-mol-vol" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                               <select id="util-mol-vol-unit" class="p-2 border rounded bg-gray-50 dark:bg-slate-800 text-xs text-slate-900 dark:text-slate-100">
                                   <option value="L">L</option>
                                   <option value="mL">mL</option>
                                   <option value="uL">¬µL</option>
                                   <option value="nL">nL</option>
                                   <option value="pL">pL</option>
                               </select>
                           </div>
                       </div>
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Conc</label>
                           <div class="flex gap-1">
                               <input type="number" id="util-mol-conc" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                               <select id="util-mol-conc-unit" class="p-2 border rounded bg-gray-50 dark:bg-slate-800 text-xs text-slate-900 dark:text-slate-100">
                                   <option value="M">M</option>
                                   <option value="mM">mM</option>
                                   <option value="uM">¬µM</option>
                                   <option value="nM">nM</option>
                                   <option value="pM">pM</option>
                               </select>
                           </div>
                       </div>
                   </div>
                   <div>
                       <label class="block text-xs text-gray-500 dark:text-gray-400">Mass</label>
                       <div class="flex gap-1">
                           <input type="number" id="util-mol-mass" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" readonly>
                           <select id="util-mol-mass-unit" class="p-2 border rounded bg-gray-50 dark:bg-slate-800 text-xs text-slate-900 dark:text-slate-100">
                               <option value="kg">kg</option>
                               <option value="g" selected>g</option>
                               <option value="mg">mg</option>
                               <option value="ug">¬µg</option>
                               <option value="ng">ng</option>
                               <option value="pg">pg</option>
                           </select>
                       </div>
                   </div>
               </div>
           </div>

           <!-- Centrifugation -->
           <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
               <h3 class="text-base font-semibold mb-3 text-slate-900 dark:text-slate-100">RPM ‚Üî RCF (g)</h3>
               <div class="space-y-3 text-sm">
                   <div>
                       <label class="block text-xs text-gray-500 dark:text-gray-400">Rotor Radius (mm)</label>
                       <input type="number" id="util-cen-r" value="100" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                   </div>
                   <div class="grid grid-cols-2 gap-2 items-center">
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Speed (RPM)</label>
                           <input type="number" id="util-cen-rpm" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                       </div>
                       <div class="text-center text-gray-400">‚Üî</div>
                   </div>
                   <div>
                        <label class="block text-xs text-gray-500 dark:text-gray-400">Force (RCF / g)</label>
                        <input type="number" id="util-cen-rcf" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                   </div>
                   <div class="text-xs text-gray-400 italic text-center mt-2">
                       g = (1.118 √ó 10‚Åª‚Åµ) √ó r √ó RPM¬≤
                   </div>
                   <div class="pt-2 border-t border-gray-100 dark:border-gray-700 mt-2">
                       <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">K-Factor Est.</label>
                       <div class="grid grid-cols-2 gap-2 mt-1">
                           <input type="number" id="cen-rmin" placeholder="Rmin (mm)" class="p-1 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                           <input type="number" id="cen-rmax" placeholder="Rmax (mm)" class="p-1 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                       </div>
                       <div class="mt-1 text-xs text-center font-mono text-slate-900 dark:text-slate-100">k = <span id="cen-k">--</span></div>
                   </div>
               </div>
           </div>

       </div>
    </div>

    <!-- Master Mix Calculator -->
    <div id="tab-reactions" class="bb-pane hidden space-y-6">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Reaction Master Mix</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Reaction Vol (ŒºL)</label>
                    <input type="number" id="mm-vol" value="20" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Sample Count (N)</label>
                    <input type="number" id="mm-n" value="10" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Excess (%)</label>
                    <input type="number" id="mm-excess" value="10" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" title="Buffer for pipetting error">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Dead Vol (ŒºL)</label>
                    <input type="number" id="mm-dead" value="0" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" title="Extra volume for troughs/robots">
                </div>
            </div>

            <div class="space-y-2 mb-4" id="mm-rows">
                <!-- Dynamic Rows -->
            </div>

            <button id="mm-add-btn" class="text-sm border border-dashed border-gray-400 text-gray-500 px-3 py-1 rounded hover:bg-gray-50 dark:hover:bg-slate-700 w-full">+ Add Reagent</button>

            <div class="mt-6 bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-indigo-700 dark:text-indigo-300">Total Master Mix</span>
                    <span class="text-xs text-indigo-600 dark:text-indigo-400">Make for <span id="mm-total-n">--</span> rxns</span>
                </div>
                <ul id="mm-result" class="text-sm space-y-1 font-mono text-slate-700 dark:text-slate-300"></ul>
            </div>
        </div>
    </div>

    <!-- Purification & Serial Dilution -->
    <div id="tab-purify" class="bb-pane hidden space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                <h3 class="text-lg font-semibold mb-3 text-slate-900 dark:text-slate-100">Ammonium Sulfate Cut</h3>
                <p class="text-xs text-gray-500 mb-4">Calculate solid (NH‚ÇÑ)‚ÇÇSO‚ÇÑ needed to reach target saturation.</p>

                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">Start Vol (mL)</label>
                            <input type="number" id="as-vol" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">Temp</label>
                            <select id="as-temp" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                                <option value="20">20¬∞C (Standard)</option>
                                <option value="4">4¬∞C (Cold Room)</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">Current %</label>
                            <input type="number" id="as-s1" value="0" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">Target %</label>
                            <input type="number" id="as-s2" value="30" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                        </div>
                    </div>

                    <div class="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-lg mt-4 border border-amber-100 dark:border-amber-800 text-center">
                        <div class="text-xs text-amber-800 dark:text-amber-400 uppercase tracking-wide font-semibold">Add Solid Salt</div>
                        <div class="text-2xl font-bold text-amber-600 dark:text-amber-500 my-1"><span id="as-result">0.0</span> g</div>
                        <div class="text-xs text-amber-700 dark:text-amber-400">Slowly, while stirring.</div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                <h3 class="text-lg font-semibold mb-3 text-slate-900 dark:text-slate-100">Serial Dilution</h3>

                <!-- Stock Prep Section -->
                <details class="mb-4 bg-indigo-50 dark:bg-indigo-900/20 rounded p-3 text-sm border border-indigo-100 dark:border-indigo-800" open>
                    <summary class="font-semibold text-indigo-700 dark:text-indigo-300 cursor-pointer text-xs uppercase tracking-wide">Preparation: First Well</summary>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <label class="block text-[10px] text-gray-500 dark:text-gray-400">Master Stock Conc</label>
                            <input type="number" id="sd-prep-stock-c" class="w-full p-1 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100 text-xs" placeholder="e.g. 100">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-500 dark:text-gray-400">Target Start Conc</label>
                            <input type="number" id="sd-prep-target-c" class="w-full p-1 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100 text-xs" placeholder="e.g. 10">
                        </div>
                    </div>
                    <div class="mt-2">
                         <label class="block text-[10px] text-gray-500 dark:text-gray-400">Required Start Volume (Well 1)</label>
                         <input type="number" id="sd-prep-vol" class="w-full p-1 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100 text-xs" value="200" placeholder="e.g. 200">
                    </div>
                    <div class="mt-2 text-xs font-mono text-center bg-white dark:bg-slate-900 p-2 rounded border border-gray-200 dark:border-gray-700 text-slate-700 dark:text-slate-300">
                        Mix <span id="sd-prep-res-stock" class="font-bold text-indigo-600 dark:text-indigo-400">--</span> Stock + <span id="sd-prep-res-buf" class="font-bold">--</span> Buffer
                    </div>
                </details>

                <hr class="border-gray-100 dark:border-gray-700 mb-4">

                <div class="space-y-3">
                     <div>
                        <label class="block text-xs text-gray-500 dark:text-gray-400">Desired Dilution Factor (e.g., 2 for 1:2)</label>
                        <input type="number" id="sd-factor" value="2" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                     </div>
                     <div>
                        <label class="block text-xs text-gray-500 dark:text-gray-400">Final Volume per Well (ŒºL)</label>
                        <input type="number" id="sd-vol" value="100" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                     </div>

                     <div class="mt-4 p-3 bg-slate-50 dark:bg-slate-900/50 rounded border border-gray-200 dark:border-gray-700 text-slate-700 dark:text-slate-300">
                         <div class="text-sm font-medium text-center mb-2">Pipetting Scheme</div>
                         <div class="flex justify-between text-xs mb-1">
                             <span>Diluent per well:</span>
                             <span class="font-mono font-bold" id="sd-diluent">-- ŒºL</span>
                         </div>
                         <div class="flex justify-between text-xs">
                             <span>Transfer volume:</span>
                             <span class="font-mono font-bold text-indigo-600 dark:text-indigo-400" id="sd-transfer">-- ŒºL</span>
                         </div>
                     </div>

                     <!-- Schematic Container -->
                     <div id="sd-schematic" class="flex gap-2 overflow-x-auto p-2 mt-4 items-end">
                         <!-- Visuals go here -->
                     </div>

                     <div class="text-xs text-gray-400 mt-2">
                         * Start with (Final Vol + Transfer Vol) in first tube.
                     </div>
                </div>
            </div>
        </div>
    </div>

  </div>
</div>

<!-- REACT APP -->
<script type="text/babel">

    const { useState, useEffect, useMemo } = React;

    // --- Visualization Helpers ---

    // Zappo Color Scheme
    const getResidueColor = (char, mode) => {
        if (char === '-') return 'bg-gray-100 text-gray-400 border-gray-200 dark:bg-gray-700 dark:text-gray-500 dark:border-gray-600';

        if (mode === 'dna') {
            const colors = {
                'A': 'bg-red-100 text-red-800 border-red-200 dark:bg-red-900 dark:text-red-200 dark:border-red-800',
                'T': 'bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:border-blue-800',
                'C': 'bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900 dark:text-yellow-200 dark:border-yellow-800',
                'G': 'bg-green-100 text-green-800 border-green-200 dark:bg-green-900 dark:text-green-200 dark:border-green-800'
            };
            return colors[char] || 'bg-gray-50 text-gray-500 dark:bg-gray-800 dark:text-gray-400';
        } else {
            // Protein (Physicochemical properties)
            // Hydrophobic (ILVAM) - Pink
            if (['I','L','V','A','M'].includes(char)) return 'bg-pink-100 text-pink-800 border-pink-200 dark:bg-pink-900 dark:text-pink-200 dark:border-pink-800';
            // Aromatic (FWY) - Orange
            if (['F','W','Y'].includes(char)) return 'bg-orange-100 text-orange-800 border-orange-200 dark:bg-orange-900 dark:text-orange-200 dark:border-orange-800';
            // Positive (KRH) - Blue
            if (['K','R','H'].includes(char)) return 'bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:border-blue-800';
            // Negative (DE) - Red
            if (['D','E'].includes(char)) return 'bg-red-100 text-red-800 border-red-200 dark:bg-red-900 dark:text-red-200 dark:border-red-800';
            // Polar (STNQ) - Green
            if (['S','T','N','Q'].includes(char)) return 'bg-green-100 text-green-800 border-green-200 dark:bg-green-900 dark:text-green-200 dark:border-green-800';
            // Proline/Glycine (Special)
            if (['P','G'].includes(char)) return 'bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900 dark:text-yellow-200 dark:border-yellow-800';
            // Cysteine
            if (char === 'C') return 'bg-yellow-200 text-yellow-900 border-yellow-300 dark:bg-yellow-600 dark:text-yellow-100 dark:border-yellow-500';

            return 'bg-gray-50 text-gray-500 dark:bg-gray-800 dark:text-gray-400';
        }
    };

    function MatrixSelector({ mode, value, onChange }) {
        if (mode === 'dna') return (
            <select className="w-full bg-slate-50 dark:bg-slate-800 dark:text-slate-400 border border-slate-300 dark:border-slate-600 rounded p-2 text-sm text-slate-600" disabled>
                <option>Standard DNA (EDNAFULL)</option>
            </select>
        );

        return (
            <select
                value={value}
                onChange={(e) => onChange(e.target.value)}
                className="w-full bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-sm"
            >
                <optgroup label="BLOSUM (Divergence)">
                    <option value="BLOSUM80">BLOSUM80 (Closely related)</option>
                    <option value="BLOSUM62">BLOSUM62 (Standard)</option>
                    <option value="BLOSUM45">BLOSUM45 (Distant)</option>
                </optgroup>
                <optgroup label="PAM (Evolutionary Time)">
                    <option value="PAM250">PAM250 (Long timeframe)</option>
                </optgroup>
            </select>
        );
    }

    function AlignmentViewer({ result, mode, matrixName }) {
        if (!result) return null;

        const { seq1Aligned, seq2Aligned, score, startI } = result;

        // Calculate Statistics
        let matches = 0;
        let similarities = 0;
        let gaps = 0;
        let length = seq1Aligned.length;

        const viz = [];

        for(let i=0; i<length; i++) {
            const c1 = seq1Aligned[i];
            const c2 = seq2Aligned[i];
            let symbol = ' ';
            let scoreVal = 0;

            if (c1 === '-' || c2 === '-') {
                gaps++;
                symbol = ' ';
            } else {
                scoreVal = BioCompute.getScore(c1, c2, matrixName);
                if (c1 === c2) {
                    matches++;
                    similarities++; // Identity implies similarity
                    symbol = '|';
                } else if (scoreVal > 0) {
                    similarities++;
                    symbol = ':'; // Strong similarity
                } else if (scoreVal === 0) {
                    symbol = '.'; // Weak
                }
            }

            viz.push({ c1, c2, symbol });
        }

        const identity = ((matches / length) * 100).toFixed(1);
        const similarity = ((similarities / length) * 100).toFixed(1);
        const gapPct = ((gaps / length) * 100).toFixed(1);

        return (
            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 mt-8 overflow-hidden animate-enter">
                {/* Header Stats */}
                <div className="bg-slate-800 dark:bg-slate-900 text-slate-200 px-6 py-4 flex flex-wrap justify-between items-center gap-4">
                    <div className="flex items-center gap-3">
                        <div className="bg-slate-700 p-2 rounded-lg">
                            <span className="block text-xs uppercase tracking-wider text-slate-400 font-bold">Raw Score</span>
                            <span className="text-xl font-mono text-emerald-400 font-bold">{score}</span>
                        </div>
                    </div>

                    <div className="flex gap-6 text-sm">
                        <div className="text-center">
                            <span className="block text-xs text-slate-400 uppercase">Identity</span>
                            <span className="font-bold text-white">{identity}%</span>
                        </div>
                        <div className="text-center">
                            <span className="block text-xs text-slate-400 uppercase">Similarity</span>
                            <span className="font-bold text-white">{similarity}%</span>
                        </div>
                        <div className="text-center">
                            <span className="block text-xs text-slate-400 uppercase">Gaps</span>
                            <span className="font-bold text-white">{gapPct}%</span>
                        </div>
                    </div>
                </div>

                {/* Alignment Canvas */}
                <div className="p-6 overflow-x-auto">
                    <div className="inline-flex flex-col space-y-1 min-w-full">
                        {/* Sequence 1 */}
                        <div className="flex">
                             {viz.map((item, idx) => (
                                 <div key={idx} className={`w-8 h-8 flex items-center justify-center font-mono text-sm font-bold border-r border-b border-t first:border-l ${getResidueColor(item.c1, mode)}`}>
                                     {item.c1}
                                 </div>
                             ))}
                        </div>

                        {/* Consensus Line */}
                        <div className="flex h-4 items-center">
                             {viz.map((item, idx) => (
                                 <div key={idx} className="w-8 flex justify-center text-slate-400 font-mono font-bold text-xs">
                                     {item.symbol}
                                 </div>
                             ))}
                        </div>

                        {/* Sequence 2 */}
                        <div className="flex">
                             {viz.map((item, idx) => (
                                 <div key={idx} className={`w-8 h-8 flex items-center justify-center font-mono text-sm font-bold border-r border-b border-t first:border-l ${getResidueColor(item.c2, mode)}`}>
                                     {item.c2}
                                 </div>
                             ))}
                        </div>

                        {/* Ruler */}
                        <div className="flex mt-1">
                             {viz.map((item, idx) => (
                                 <div key={idx} className="w-8 flex justify-center text-[10px] text-slate-300 font-mono">
                                     {(idx + 1) % 10 === 0 ? idx + 1 : (idx === 0 ? 1 : '')}
                                 </div>
                             ))}
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    function App() {
        const [mode, setMode] = useState('protein');
        const [algo, setAlgo] = useState('local');
        const [matrix, setMatrix] = useState('BLOSUM62');

        // Affine Gap Penalties
        const [gapOpen, setGapOpen] = useState(-11);
        const [gapExt, setGapExt] = useState(-1);

        const [seq1, setSeq1] = useState("MSTKYNPTQEEHLKAVFKADNDAVLCAEKLPSL");
        const [seq2, setSeq2] = useState("MSTKYNPTQAEHLKAVFKADNDAV");

        const [result, setResult] = useState(null);
        const [error, setError] = useState('');

        const handleModeChange = (newMode) => {
            setMode(newMode);
            if (newMode === 'dna') {
                setMatrix('EDNAFULL');
                setSeq1("ATGCGTCGTAGCTAGCTAG");
                setSeq2("ATGCGTCGACGT");
                setGapOpen(-10);
            } else {
                setMatrix('BLOSUM62');
                setSeq1("HEAGAWGHEE");
                setSeq2("PAWHEAE");
                setGapOpen(-11);
            }
        };

        const runAlignment = () => {
            setError('');
            setResult(null);

            // Sanitize
            const cleanS1 = seq1.toUpperCase().replace(/[\s\r\n]/g, '');
            const cleanS2 = seq2.toUpperCase().replace(/[\s\r\n]/g, '');

            if(!cleanS1 || !cleanS2) return;

            // Validation
            const validPattern = mode === 'dna' ? /^[ATCGNX-]*$/ : /^[ARNDCQEGHILKMFPSTWYVBZX*-]*$/;
            if (!validPattern.test(cleanS1) || !validPattern.test(cleanS2)) {
                setError(`Invalid characters found for ${mode.toUpperCase()} mode.`);
                return;
            }

            try {
                // Yield to main thread for UI update before crunching
                setTimeout(() => {
                    const res = BioCompute.run(cleanS1, cleanS2, algo, matrix, parseInt(gapOpen), parseInt(gapExt));
                    setResult(res);
                }, 10);
            } catch (e) {
                setError(e.message);
            }
        };

        return (
            <div className="max-w-6xl mx-auto px-4 py-10">
                <header className="mb-8">
                    <h1 className="text-4xl font-extrabold tracking-tight text-slate-900 dark:text-slate-100">
                        BioAlign <span className="text-blue-600 dark:text-blue-400">Pro</span>
                    </h1>
                    <p className="text-slate-500 dark:text-slate-400 mt-2 text-lg">
                        Gotoh's Algorithm with Affine Gap Penalties
                    </p>
                </header>

                <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">

                    {/* LEFT PANEL: CONTROLS */}
                    <div className="lg:col-span-4 space-y-6">
                        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                            <h2 className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-4">Configuration</h2>

                            {/* Algorithm Mode */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Method</label>
                                <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-lg">
                                    <button
                                        onClick={() => setAlgo('local')}
                                        className={`flex-1 py-1.5 text-xs font-bold rounded shadow-sm transition-all ${algo === 'local' ? 'bg-white dark:bg-slate-700 text-blue-600 dark:text-blue-400' : 'text-slate-500 dark:text-slate-400'}`}
                                    >
                                        Local (SW)
                                    </button>
                                    <button
                                        onClick={() => setAlgo('global')}
                                        className={`flex-1 py-1.5 text-xs font-bold rounded shadow-sm transition-all ${algo === 'global' ? 'bg-white dark:bg-slate-700 text-purple-600 dark:text-purple-400' : 'text-slate-500 dark:text-slate-400'}`}
                                    >
                                        Global (NW)
                                    </button>
                                </div>
                            </div>

                            {/* Molecule Type */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Molecule</label>
                                <div className="flex gap-2">
                                    <label className="flex items-center gap-2 cursor-pointer text-slate-700 dark:text-slate-300">
                                        <input type="radio" name="mode" checked={mode==='dna'} onChange={() => handleModeChange('dna')} />
                                        <span className="text-sm">DNA</span>
                                    </label>
                                    <label className="flex items-center gap-2 cursor-pointer text-slate-700 dark:text-slate-300">
                                        <input type="radio" name="mode" checked={mode==='protein'} onChange={() => handleModeChange('protein')} />
                                        <span className="text-sm">Protein</span>
                                    </label>
                                </div>
                            </div>

                            {/* Matrix */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Substitution Matrix</label>
                                <MatrixSelector mode={mode} value={matrix} onChange={setMatrix} />
                            </div>

                            {/* Penalties */}
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Gap Open</label>
                                    <input
                                        type="number"
                                        max="0"
                                        value={gapOpen}
                                        onChange={(e) => setGapOpen(e.target.value)}
                                        className="w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white rounded p-2 text-sm"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Gap Ext</label>
                                    <input
                                        type="number"
                                        max="0"
                                        value={gapExt}
                                        onChange={(e) => setGapExt(e.target.value)}
                                        className="w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white rounded p-2 text-sm"
                                    />
                                </div>
                            </div>

                            <button
                                onClick={runAlignment}
                                className="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition-colors"
                            >
                                Run Alignment
                            </button>
                        </div>

                        {/* Legend */}
                        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                             <h2 className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">Color Key {mode === 'protein' ? '(Zappo)' : ''}</h2>
                             <div className="text-xs space-y-1 text-slate-700 dark:text-slate-300">
                                {mode === 'dna' ? (
                                    <>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-red-100 border border-red-300"></div> Adenine (A)</div>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-blue-100 border border-blue-300"></div> Thymine (T)</div>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-yellow-100 border border-yellow-300"></div> Cytosine (C)</div>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-green-100 border border-green-300"></div> Guanine (G)</div>
                                    </>
                                ) : (
                                    <>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-pink-100 border border-pink-300"></div> Aliphatic/Hydrophobic (ILVAM)</div>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-orange-100 border border-orange-300"></div> Aromatic (FWY)</div>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-blue-100 border border-blue-300"></div> Positive (KRH)</div>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-red-100 border border-red-300"></div> Negative (DE)</div>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-green-100 border border-green-300"></div> Hydrophilic (STNQ)</div>
                                    </>
                                )}
                             </div>
                        </div>
                    </div>

                    {/* RIGHT PANEL: INPUTS & OUTPUT */}
                    <div className="lg:col-span-8">
                        <div className="space-y-4">
                            <div>
                                <label className="flex justify-between text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">
                                    <span>Sequence 1</span>
                                    <span className="text-xs font-normal text-slate-400">{seq1.length} chars</span>
                                </label>
                                <textarea
                                    className="w-full p-3 font-mono text-sm border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 rounded-lg focus:ring-2 focus:ring-blue-500 h-28 uppercase"
                                    value={seq1}
                                    onChange={(e) => setSeq1(e.target.value)}
                                    placeholder="Paste FASTA or raw sequence..."
                                />
                            </div>
                            <div>
                                <label className="flex justify-between text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">
                                    <span>Sequence 2</span>
                                    <span className="text-xs font-normal text-slate-400">{seq2.length} chars</span>
                                </label>
                                <textarea
                                    className="w-full p-3 font-mono text-sm border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 rounded-lg focus:ring-2 focus:ring-blue-500 h-28 uppercase"
                                    value={seq2}
                                    onChange={(e) => setSeq2(e.target.value)}
                                    placeholder="Paste FASTA or raw sequence..."
                                />
                            </div>
                        </div>

                        {error && (
                            <div className="mt-4 p-4 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 border border-red-200 dark:border-red-800 rounded-lg text-sm font-medium animate-enter">
                                {error}
                            </div>
                        )}

                        <AlignmentViewer result={result} mode={mode} matrixName={matrix} />
                    </div>
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('bioalign-root'));
    root.render(<App />);

</script>

<script>
(function(){
    // --- Dependency Loading ---
    function loadScripts(srcs) {
        return Promise.all(srcs.map(src => {
            return new Promise((resolve, reject) => {
                // Dependency Checks to prevent reloading
                if (window.PROTEIN_UTILS && src.includes('definitions.js')) { resolve(); return; }
                if (window.LAB_CONSTANTS && src.includes('labConstants.js')) { resolve(); return; }
                if (window.React && src.includes('react.development')) { resolve(); return; }
                if (window.ReactDOM && src.includes('react-dom')) { resolve(); return; }
                if (window.Babel && src.includes('babel.min')) { resolve(); return; }
                if (window.BioCompute && src.includes('bio_align_engine.js')) { resolve(); return; }

                const s = document.createElement('script');
                s.src = src;
                if(src.includes('react') || src.includes('babel')) s.crossOrigin = "anonymous";
                s.onload = resolve;
                s.onerror = () => { console.warn("Failed to load "+src); resolve(); };
                document.head.appendChild(s);
            });
        }));
    }

    loadScripts([
        'labConstants.js',
        'definitions.js',
        'https://unpkg.com/react@18/umd/react.development.js',
        'https://unpkg.com/react-dom@18/umd/react-dom.development.js',
        'https://unpkg.com/@babel/standalone/babel.min.js',
        'bio_align_engine.js'
    ]).then(() => {
        initBioBench();
        if(window.Babel) window.Babel.transformScriptTags();
    });

    function initBioBench(){
        const CONSTANTS = window.LAB_CONSTANTS || { chemicals: [] };
        const PROT_UTILS = window.PROTEIN_UTILS || {
            getProteinParams: ()=>({mw:0}), parseFastaFlexible: ()=>[{header:'', seq:''}]
        };

        // --- Tab Logic ---
        const tabs = document.querySelectorAll('.bb-tab');
        const panes = document.querySelectorAll('.bb-pane');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => {
                    t.classList.remove('active', 'border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400');
                    t.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400');
                });
                tab.classList.add('active', 'border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400');
                tab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400');

                const target = tab.dataset.target;
                panes.forEach(p => {
                    if(p.id === target) p.classList.remove('hidden');
                    else p.classList.add('hidden');
                });
            });
        });

        // --- pH Logic ---
        const phTarget = document.getElementById('ph-target');
        const phPka = document.getElementById('ph-pka');
        const phOut = document.getElementById('ph-ratio-out');

        function calcPH(){
            const ph = parseFloat(phTarget.value);
            const pka = parseFloat(phPka.value);
            if(ph && pka){
                const r = Math.pow(10, ph - pka);
                phOut.textContent = `Ratio (Base/Acid): ${r.toFixed(2)}`;
            } else {
                phOut.textContent = "Ratio (Base/Acid): --";
            }
        }
        phTarget.addEventListener('input', calcPH);
        phPka.addEventListener('input', calcPH);

        // --- Buffer Mixer Logic ---
        const bufferRows = document.getElementById('buffer-rows');
        const addCompBtn = document.getElementById('add-component-btn');
        const totalVolIn = document.getElementById('buffer-total-vol');
        const totalVolUnit = document.getElementById('buffer-total-unit');
        const recipeList = document.getElementById('buffer-recipe-list');
        const btnImportJson = document.getElementById('btn-import-json');
        const fileImportJson = document.getElementById('file-import-json');
        const btnExportJson = document.getElementById('btn-export-json');
        const presetSel = document.getElementById('buffer-preset-sel');

        // Prepare Datalist once
        const chemDatalist = document.createElement('datalist');
        chemDatalist.id = 'chem-datalist';
        CONSTANTS.chemicals.sort((a,b)=>a.name.localeCompare(b.name)).forEach(c => {
             const opt = document.createElement('option');
             opt.value = c.name;
             opt.dataset.mw = c.mw;
             chemDatalist.appendChild(opt);
        });
        document.body.appendChild(chemDatalist);

        function createBufferRow(data = {}){
            const div = document.createElement('div');
            div.className = "grid grid-cols-1 md:grid-cols-[2fr,minmax(7rem,auto),1fr,1fr,auto,auto] gap-3 items-end p-3 border border-gray-100 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-slate-700/50";
            const rowId = Math.random().toString(36).substr(2,9);

            const initialIsLiquid = data.isLiquid || false;
            const initialUnit = data.unit || "mM";
            const initialStockUnit = data.stockUnit || "M";

            div.innerHTML = `
                <div>
                   <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Component</label>
                   <div class="flex gap-1">
                       <input type="text" list="chem-datalist" class="comp-name w-full p-2 border rounded bg-white text-slate-900 dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-sm dark:text-slate-100" placeholder="Search or type...">
                       <button class="comp-search text-xs bg-indigo-50 dark:bg-slate-700 border border-indigo-200 dark:border-slate-600 rounded px-2 hover:bg-indigo-100 dark:hover:bg-slate-600 dark:text-slate-100" title="Fetch MW from PubChem">üîç</button>
                   </div>
                </div>
                <div class="min-w-[6rem]">
                   <div class="flex justify-between items-center mb-1">
                        <label class="block text-xs text-gray-500 dark:text-gray-400 label-mw">${initialIsLiquid ? "Stock Conc" : "MW (g/mol)"}</label>
                        <div class="flex items-center gap-1">
                            <input type="checkbox" class="comp-is-liquid" ${initialIsLiquid ? "checked" : ""} id="chk-${rowId}">
                            <label for="chk-${rowId}" class="text-[10px] text-indigo-500 dark:text-indigo-400 cursor-pointer" title="Liquid Stock Solution">Liq</label>
                        </div>
                   </div>
                   <div class="flex gap-1">
                       <input type="number" step="0.01" class="comp-mw w-full p-2 border rounded bg-white text-slate-900 dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-sm dark:text-slate-100" placeholder="${initialIsLiquid ? 'e.g. 5' : '0.00'}">
                       <select class="comp-stock-unit ${initialIsLiquid ? '' : 'hidden'} w-16 p-1 border rounded bg-gray-50 dark:bg-slate-800 border-gray-300 dark:border-gray-600 text-xs text-slate-900 dark:text-slate-100">
                           <option value="M" ${initialStockUnit==='M'?'selected':''}>M</option>
                           <option value="mM" ${initialStockUnit==='mM'?'selected':''}>mM</option>
                           <option value="%" ${initialStockUnit==='%'?'selected':''}>%</option>
                           <option value="x" ${initialStockUnit==='x'?'selected':''}>x</option>
                       </select>
                   </div>
                </div>
                <div class="w-20">
                   <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">+H‚ÇÇO (n)</label>
                   <input type="number" step="0.5" min="0" class="comp-hydro w-full p-2 border rounded bg-white text-slate-900 dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-sm dark:text-slate-100" ${initialIsLiquid ? "disabled" : ""}>
                </div>
                <div>
                   <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Conc</label>
                   <input type="number" step="any" class="comp-conc w-full p-2 border rounded bg-white text-slate-900 dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-sm dark:text-slate-100">
                </div>
                <div class="w-24">
                   <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Unit</label>
                   <select class="comp-unit w-full p-2 border rounded bg-white text-slate-900 dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-sm dark:text-slate-100">
                      <option value="mM" ${initialUnit==='mM'?'selected':''}>mM</option>
                      <option value="M" ${initialUnit==='M'?'selected':''}>M</option>
                      <option value="%" ${initialUnit==='%'?'selected':''}>% (w/v)</option>
                   </select>
                </div>
                <button class="remove-row text-red-500 hover:text-red-700 p-2 mb-1" title="Remove">‚úï</button>
            `;

            // Safe assignment
            if(data.name) div.querySelector('.comp-name').value = data.name;
            if(data.mw) div.querySelector('.comp-mw').value = data.mw;
            if(data.hydro) div.querySelector('.comp-hydro').value = data.hydro;
            if(data.conc) div.querySelector('.comp-conc').value = data.conc;

            const nameInput = div.querySelector('.comp-name');
            const mwInput = div.querySelector('.comp-mw');
            const searchBtn = div.querySelector('.comp-search');
            const isLiquidChk = div.querySelector('.comp-is-liquid');
            const mwLabel = div.querySelector('.label-mw');
            const hydroInput = div.querySelector('.comp-hydro');
            const stockUnitSel = div.querySelector('.comp-stock-unit');

            isLiquidChk.addEventListener('change', () => {
                if(isLiquidChk.checked){
                    mwLabel.textContent = "Stock Conc";
                    mwInput.placeholder = "e.g. 5";
                    stockUnitSel.classList.remove('hidden');
                    hydroInput.disabled = true;
                    hydroInput.parentElement.classList.add('opacity-50');
                } else {
                    mwLabel.textContent = "MW (g/mol)";
                    mwInput.placeholder = "0.00";
                    stockUnitSel.classList.add('hidden');
                    hydroInput.disabled = false;
                    hydroInput.parentElement.classList.remove('opacity-50');
                }
                updateRecipe();
            });

            nameInput.addEventListener('input', (e) => {
                const val = e.target.value;
                const valLower = val.toLowerCase();
                let match = CONSTANTS.chemicals.find(c => c.name === val);
                if (!match && val.length > 1) {
                     match = CONSTANTS.chemicals.find(c => {
                         if (c.name.toLowerCase() === valLower) return true;
                         if (c.synonyms && c.synonyms.some(s => s.toLowerCase() === valLower)) return true;
                         return false;
                     });
                }
                if(match) {
                    mwInput.value = match.mw;
                    updateRecipe();
                }
            });

            nameInput.addEventListener('keydown', (e) => {
                if(e.key === 'Enter'){
                    const val = nameInput.value;
                    const match = CONSTANTS.chemicals.find(c => c.name.toLowerCase() === val.toLowerCase() || (c.synonyms && c.synonyms.some(s => s.toLowerCase() === val.toLowerCase())));
                    if(!match) searchBtn.click();
                    else { nameInput.value = match.name; mwInput.value = match.mw; updateRecipe(); }
                }
            });

            searchBtn.addEventListener('click', async () => {
                 const name = nameInput.value.trim();
                 if(!name) return;
                 const originalText = searchBtn.textContent;
                 searchBtn.textContent = '‚è≥';
                 searchBtn.disabled = true;
                 try {
                     const resp = await fetch(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(name)}/property/MolecularWeight/JSON`);
                     if(!resp.ok) throw new Error(resp.status === 404 ? 'Not found' : 'API Error');
                     const data = await resp.json();
                     if(data.PropertyTable && data.PropertyTable.Properties.length > 0){
                         mwInput.value = data.PropertyTable.Properties[0].MolecularWeight;
                         if(isLiquidChk.checked) { isLiquidChk.checked = false; isLiquidChk.dispatchEvent(new Event('change')); }
                         updateRecipe();
                         searchBtn.textContent = '‚úÖ';
                         setTimeout(() => searchBtn.textContent = originalText, 1500);
                     } else throw new Error('No properties');
                 } catch(err) {
                     console.error(err);
                     searchBtn.textContent = '‚ùå';
                     setTimeout(() => searchBtn.textContent = originalText, 1500);
                 } finally { searchBtn.disabled = false; }
            });

            div.querySelector('.remove-row').addEventListener('click', () => { div.remove(); updateRecipe(); });
            div.querySelectorAll('input, select').forEach(el => el.addEventListener('input', updateRecipe));
            return div;
        }

        function updateRecipe(){
            const volVal = parseFloat(totalVolIn.value) || 0;
            const volUnit = totalVolUnit.value;
            const volL = volUnit === 'mL' ? volVal / 1000 : volVal;

            if(volL <= 0) { recipeList.innerHTML = '<li class="text-red-500">Invalid volume.</li>'; return; }

            let html = `<li><strong>Total Volume:</strong> ${volVal} ${volUnit}</li>`;
            let hasComp = false;

            bufferRows.querySelectorAll('div.grid').forEach(row => {
                const name = row.querySelector('.comp-name').value || "Unknown";
                const valInput = parseFloat(row.querySelector('.comp-mw').value) || 0;
                const hydroN = parseFloat(row.querySelector('.comp-hydro').value) || 0;
                const conc = parseFloat(row.querySelector('.comp-conc').value);
                const unit = row.querySelector('.comp-unit').value;
                const isLiquid = row.querySelector('.comp-is-liquid').checked;

                if(valInput > 0 && conc > 0){
                    hasComp = true;
                    if(isLiquid){
                        const stockVal = valInput;
                        const stockUnit = row.querySelector('.comp-stock-unit').value;
                        let volNeededL = 0; let valid = false;

                        if (stockUnit === 'M' || stockUnit === 'mM') {
                            const sM = stockUnit === 'M' ? stockVal : stockVal/1000;
                            let tM = unit === 'M' ? conc : (unit === 'mM' ? conc/1000 : 0);
                            if(tM > 0) { volNeededL = (tM * volL) / sM; valid = true; }
                        } else if (stockUnit === '%' && unit === '%') {
                            volNeededL = (conc * volL) / stockVal; valid = true;
                        } else if (stockUnit === 'x') {
                             // Assuming conc target is "1" for 1x? No, let's treat conc as factor.
                             // e.g. Stock 10x, Target 1x.
                             // Input: Conc=1, Unit=x (we don't have x unit in dropdown).
                             // User usually enters 1 'M' ?? No.
                             // Fallback: simple dilution C1V1=C2V2.
                             // If Stock=10, Conc=1.
                             volNeededL = (conc * volL) / stockVal; valid = true;
                        }

                        if(valid){
                            let volDisplay = '';
                            if(volNeededL < 0.000001) volDisplay = (volNeededL * 1e9).toFixed(1) + ' nL';
                            else if(volNeededL < 0.001) volDisplay = (volNeededL * 1e6).toFixed(1) + ' ŒºL';
                            else if(volNeededL < 1) volDisplay = (volNeededL * 1000).toFixed(1) + ' mL';
                            else volDisplay = volNeededL.toFixed(3) + ' L';
                            html += `<li class="flex justify-between border-b border-dotted border-gray-300 dark:border-gray-700 pb-1"><span>${name} (${conc} ${unit})</span><span class="font-mono font-bold text-indigo-600 dark:text-indigo-400">Add ${volDisplay} <span class="text-[10px] text-gray-400 font-normal">of ${stockVal}${stockUnit}</span></span></li>`;
                        } else {
                            html += `<li class="text-red-400 text-xs">Cannot calc volume for ${name}. Check units.</li>`;
                        }
                    } else {
                        const effMw = valInput + (hydroN * 18.015);
                        let massG = 0;
                        if(unit === 'M') massG = conc * volL * effMw;
                        else if (unit === 'mM') massG = (conc / 1000) * volL * effMw;
                        else if (unit === '%') massG = (conc / 100) * (volL*1000);

                        const hydroNote = hydroN > 0 ? ` (+${hydroN} H‚ÇÇO)` : '';
                        const massDisp = massG < 1 ? (massG*1000).toFixed(1)+' mg' : massG.toFixed(3)+' g';
                        html += `<li class="flex justify-between border-b border-dotted border-gray-300 dark:border-gray-700 pb-1"><span>${name} (${conc} ${unit})${hydroNote}</span><span class="font-mono font-bold">${massDisp}</span></li>`;
                    }
                }
            });

            if(!hasComp) html += '<li class="italic text-gray-400">Add components above.</li>';
            else html += `<li class="mt-2 text-xs text-gray-500">Fill to ${volVal} ${volUnit} with water.</li>`;
            recipeList.innerHTML = html;
        }

        addCompBtn.addEventListener('click', () => { bufferRows.appendChild(createBufferRow()); });
        totalVolIn.addEventListener('input', updateRecipe);
        totalVolUnit.addEventListener('change', updateRecipe);

        // JSON Import/Export
        btnExportJson.addEventListener('click', () => {
             const data = {
                 volume: totalVolIn.value,
                 volUnit: totalVolUnit.value,
                 components: []
             };
             bufferRows.querySelectorAll('div.grid').forEach(row => {
                 data.components.push({
                     name: row.querySelector('.comp-name').value,
                     mw: row.querySelector('.comp-mw').value,
                     isLiquid: row.querySelector('.comp-is-liquid').checked,
                     hydro: row.querySelector('.comp-hydro').value,
                     conc: row.querySelector('.comp-conc').value,
                     unit: row.querySelector('.comp-unit').value,
                     stockUnit: row.querySelector('.comp-stock-unit').value
                 });
             });
             const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a'); a.href = url; a.download = 'buffer_recipe.json';
             document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        });

        btnImportJson.addEventListener('click', () => fileImportJson.click());
        fileImportJson.addEventListener('change', (e) => {
             const f = e.target.files[0];
             if(!f) return;
             const r = new FileReader();
             r.onload = (ev) => {
                 try {
                     const data = JSON.parse(ev.target.result);
                     totalVolIn.value = data.volume || 1;
                     totalVolUnit.value = data.volUnit || 'L';
                     bufferRows.innerHTML = '';
                     if(data.components && Array.isArray(data.components)){
                         data.components.forEach(c => bufferRows.appendChild(createBufferRow(c)));
                     }
                     updateRecipe();
                 } catch(err){ alert("Invalid JSON"); }
             };
             r.readAsText(f);
             e.target.value = '';
        });

        // Presets
        const PRESETS = {
            "PBS_1x": { volume: 1, volUnit: 'L', components: [
                { name: "NaCl", mw: 58.44, conc: 137, unit: "mM" },
                { name: "KCl", mw: 74.55, conc: 2.7, unit: "mM" },
                { name: "Na2HPO4", mw: 141.96, conc: 10, unit: "mM" },
                { name: "KH2PO4", mw: 136.09, conc: 1.8, unit: "mM" }
            ]},
            "PBST_1x": { volume: 1, volUnit: 'L', components: [
                { name: "NaCl", mw: 58.44, conc: 137, unit: "mM" },
                { name: "KCl", mw: 74.55, conc: 2.7, unit: "mM" },
                { name: "Na2HPO4", mw: 141.96, conc: 10, unit: "mM" },
                { name: "KH2PO4", mw: 136.09, conc: 1.8, unit: "mM" },
                { name: "Tween 20", mw: 100, isLiquid: true, conc: 0.1, unit: "%", stockUnit: "%" }
            ]},
            "TBS_1x": { volume: 1, volUnit: 'L', components: [
                { name: "Tris-base", mw: 121.14, conc: 50, unit: "mM" },
                { name: "NaCl", mw: 58.44, conc: 150, unit: "mM" }
            ]},
            "TBST_1x": { volume: 1, volUnit: 'L', components: [
                { name: "Tris-base", mw: 121.14, conc: 50, unit: "mM" },
                { name: "NaCl", mw: 58.44, conc: 150, unit: "mM" },
                { name: "Tween 20", mw: 100, isLiquid: true, conc: 0.1, unit: "%", stockUnit: "%" }
            ]},
            "HBS_1x": { volume: 1, volUnit: 'L', components: [
                { name: "HEPES", mw: 238.3, conc: 20, unit: "mM" },
                { name: "NaCl", mw: 58.44, conc: 150, unit: "mM" }
            ]},
            "TE_1x": { volume: 1, volUnit: 'L', components: [
                { name: "Tris-HCl", mw: 157.6, conc: 10, unit: "mM" },
                { name: "EDTA", mw: 372.24, conc: 1, unit: "mM" }
            ]},
            "TAE_1x": { volume: 1, volUnit: 'L', components: [
                 { name: "Tris-base", mw: 121.14, conc: 40, unit: "mM" },
                 { name: "Acetic Acid", mw: 60.05, isLiquid: true, conc: 20, unit: "mM", stockUnit: "M" },
                 { name: "EDTA", mw: 372.24, conc: 1, unit: "mM" }
            ]}
        };

        presetSel.addEventListener('change', () => {
            const p = PRESETS[presetSel.value];
            if(p){
                if(confirm("Replace current recipe?")){
                    bufferRows.innerHTML = '';
                    totalVolIn.value = p.volume;
                    totalVolUnit.value = p.volUnit;
                    p.components.forEach(c => bufferRows.appendChild(createBufferRow(c)));
                    updateRecipe();
                }
                presetSel.value = "";
            }
        });

        // Initial Empty Row
        bufferRows.appendChild(createBufferRow());


        // --- Macromolecule Logic ---
        const pSeq = document.getElementById('macro-prot-seq');
        const pMW = document.getElementById('macro-prot-mw');
        const pBaseMW = document.getElementById('macro-prot-base-mw');
        const pEps = document.getElementById('macro-prot-eps');
        const pAbsPerc = document.getElementById('macro-prot-abs-percent');
        const pA280 = document.getElementById('macro-prot-a280');
        const pMg = document.getElementById('macro-prot-res-mgml-in');
        const pUm = document.getElementById('macro-prot-res-um');
        const btnEpsRed = document.getElementById('btn-eps-red');
        const btnEpsOx = document.getElementById('btn-eps-ox');
        const valEpsRed = document.getElementById('val-eps-red');
        const valEpsOx = document.getElementById('val-eps-ox');

        // Mods List
        const modListContainer = document.getElementById('mod-list-container');
        const btnAddMod = document.getElementById('btn-add-mod');
        const modTotalDisplay = document.getElementById('mod-total-display');

        function createModRow(){
             const div = document.createElement('div');
             div.className = "mod-row grid grid-cols-[1.5fr,1fr,1fr,auto] gap-2 items-center";
             div.innerHTML = `
                 <select class="mod-type p-1 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                     <option value="custom">Custom</option>
                     <option value="phos">Phospho (+80)</option>
                     <option value="glyco-n-high">N-Glyc (HighMan ~1.5k)</option>
                     <option value="glyco-n-cpx">N-Glyc (Complex ~2.5k)</option>
                     <option value="glyco-o">O-Glyc (Core1 ~0.37k)</option>
                 </select>
                 <input type="number" class="mod-count w-full p-1 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="Count" value="1">
                 <div class="relative">
                    <input type="number" step="0.1" class="mod-mass w-full p-1 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="Mass (kDa)">
                 </div>
                 <button class="remove-mod text-red-400 hover:text-red-600 px-1">‚úï</button>
             `;

             const typeSel = div.querySelector('.mod-type');
             const massIn = div.querySelector('.mod-mass');

             typeSel.addEventListener('change', () => {
                 const t = typeSel.value;
                 if(t === 'phos') massIn.value = 0.08;
                 else if(t === 'glyco-n-high') massIn.value = 1.5;
                 else if(t === 'glyco-n-cpx') massIn.value = 2.5;
                 else if(t === 'glyco-o') massIn.value = 0.365;
                 updateMods();
             });

             div.querySelectorAll('input').forEach(i => i.addEventListener('input', updateMods));
             div.querySelector('.remove-mod').addEventListener('click', () => { div.remove(); updateMods(); });

             return div;
        }

        btnAddMod.addEventListener('click', () => { modListContainer.appendChild(createModRow()); updateMods(); });

        function updateMods(){
             const base = parseFloat(pBaseMW.value) || 0;
             let addedMass = 0;

             modListContainer.querySelectorAll('.mod-row').forEach(row => {
                 const count = parseFloat(row.querySelector('.mod-count').value) || 0;
                 const mass = parseFloat(row.querySelector('.mod-mass').value) || 0;
                 addedMass += count * mass;
             });

             if(base > 0) {
                 pMW.value = (base + addedMass).toFixed(2);
             }
             modTotalDisplay.textContent = `Mods: +${addedMass.toFixed(2)} kDa`;
             recalE1();
        }

        function updateProtParams(){
            const raw = pSeq.value;
            // Use shared parser
            const records = PROT_UTILS.parseFastaFlexible(raw);
            if(records.length > 0 && records[0].seq) {
                const seq = records[0].seq;
                const params = PROT_UTILS.getProteinParams(seq);

                if(params.mw > 0.02) {
                    pBaseMW.value = params.mw.toFixed(2);
                    valEpsRed.textContent = params.epsRed;
                    valEpsOx.textContent = params.epsOx;

                    btnEpsRed.dataset.val = params.epsRed;
                    btnEpsOx.dataset.val = params.epsOx;

                    if(!pEps.value || pEps.value == "0") pEps.value = params.epsRed;
                    updateMods();
                }
            }
        }

        pSeq.addEventListener('input', updateProtParams);
        btnEpsRed.onclick = () => { if(btnEpsRed.dataset.val) { pEps.value = btnEpsRed.dataset.val; recalE1(); } };
        btnEpsOx.onclick = () => { if(btnEpsOx.dataset.val) { pEps.value = btnEpsOx.dataset.val; recalE1(); } };

        function calcProtConcFromA280(){
            const A = parseFloat(pA280.value) || 0;
            const abs1 = parseFloat(pAbsPerc.value);
            if(abs1 > 0){
                const mgml = A / abs1;
                pMg.value = mgml.toFixed(3);
                const mwKDa = parseFloat(pMW.value);
                if(mwKDa > 0){
                    const um = (mgml / mwKDa) * 1000;
                    pUm.textContent = um.toFixed(2);
                }
            }
        }

        function calcProtConcFromMg(){
             const mgml = parseFloat(pMg.value) || 0;
             const abs1 = parseFloat(pAbsPerc.value);
             const mwKDa = parseFloat(pMW.value);
             if(abs1 > 0) pA280.value = (mgml * abs1).toFixed(3);
             if(mwKDa > 0) {
                 const um = (mgml / mwKDa) * 1000;
                 pUm.textContent = um.toFixed(2);
             }
        }

        pA280.addEventListener('input', calcProtConcFromA280);
        pMg.addEventListener('input', calcProtConcFromMg);

        function recalE1(){
             const e = parseFloat(pEps.value);
             const mw = parseFloat(pMW.value);
             if(e && mw) pAbsPerc.value = (e / (mw*1000)).toFixed(3);
             calcProtConcFromA280();
        }
        pEps.addEventListener('input', recalE1);
        pMW.addEventListener('input', recalE1);
        pAbsPerc.addEventListener('input', calcProtConcFromA280);


        // NA Logic
        const nType = document.getElementById('macro-na-type');
        const nSeq = document.getElementById('macro-na-seq');
        const nLen = document.getElementById('macro-na-len');
        const nMww = document.getElementById('macro-na-mw');
        const nConc = document.getElementById('macro-na-ngul');
        const nRes = document.getElementById('macro-na-nm');
        const nTm = document.getElementById('macro-na-tm');
        const nTmBox = document.getElementById('macro-na-tm-box');

        function calcNaParams(){
            const type = nType.value;
            const seq = nSeq.value.toUpperCase().replace(/[^A-Z]/g,'');

            let len = parseInt(nLen.value) || 0;
            if(seq.length > 0) {
                len = seq.length;
                nLen.value = len;
            }

            let mw = 0;
            if(len > 0){
                if(type === 'dsDNA') mw = len * 650;
                else if (type === 'ssDNA') mw = len * 330;
                else if (type === 'ssRNA') mw = len * 340;
            }
            nMww.value = mw > 0 ? mw.toFixed(0) : '';

            const concNg = parseFloat(nConc.value) || 0;
            if(mw > 0 && concNg > 0){
                const nm = (concNg * 1e6) / mw;
                nRes.value = nm.toFixed(1);
            } else {
                nRes.value = '';
            }

            if(seq.length > 0 && (type === 'dsDNA' || type === 'ssDNA')){
                nTmBox.classList.remove('hidden');
                let tm = 0;
                const A = (seq.match(/A/g)||[]).length;
                const T = (seq.match(/T/g)||[]).length;
                const G = (seq.match(/G/g)||[]).length;
                const C = (seq.match(/C/g)||[]).length;

                if(len < 14) tm = 2*(A+T) + 4*(G+C);
                else tm = 64.9 + 41 * (G+C - 16.4)/len;
                nTm.textContent = tm.toFixed(1);
            } else {
                nTmBox.classList.add('hidden');
            }
        }

        [nType, nSeq, nLen, nConc].forEach(el => el.addEventListener('input', calcNaParams));

        // --- Cryo EM Logic ---
        const cPix = document.getElementById('cryo-pix');
        const cBox = document.getElementById('cryo-box');
        const cBin = document.getElementById('cryo-bin');
        const cFcBox = document.getElementById('cryo-fc-box');
        const cTargetRes = document.getElementById('cryo-target-res');
        const cSuggestion = document.getElementById('cryo-box-suggestion');

        function isGoodBox(n) {
             if(n % 2 !== 0) return false;
             let x = n;
             [2,3,5,7].forEach(f => { while(x % f === 0) x /= f; });
             return x === 1;
        }

        function findNextGoodBox(start) {
            let n = Math.ceil(start);
            if(n%2 !== 0) n++;
            while(!isGoodBox(n)) n+=2;
            return n;
        }

        function updateCryo(){
            const pix = parseFloat(cPix.value) || 0;
            const box = parseFloat(cBox.value) || 0;
            let bin = parseFloat(cBin.value) || 1;
            const fcBox = parseFloat(cFcBox.value);

            document.getElementById('cryo-res-pix-raw').textContent = pix ? pix.toFixed(3) : '--';
            document.getElementById('cryo-res-nyq-raw').textContent = pix ? (2*pix).toFixed(2) + ' √Ö' : '--';
            document.getElementById('cryo-res-box-raw').textContent = box ? box : '--';
            document.getElementById('cryo-res-phys-raw').textContent = (pix && box) ? (pix*box).toFixed(1) + ' √Ö' : '--';

            let effBin = bin;
            let effBox = box / bin;

            if(fcBox && box){
                effBox = fcBox;
                effBin = box / fcBox;
            }

            if(pix > 0 && effBox > 0){
                const bPix = pix * effBin;
                document.getElementById('cryo-res-pix-bin').textContent = bPix.toFixed(3);
                document.getElementById('cryo-res-nyq-bin').textContent = (2*bPix).toFixed(2) + ' √Ö';
                document.getElementById('cryo-res-box-bin').textContent = effBox.toFixed(1);
                document.getElementById('cryo-res-phys-bin').textContent = (bPix*effBox).toFixed(1) + ' √Ö';
            }

            if(fcBox && !isGoodBox(fcBox)){
                const better = findNextGoodBox(fcBox);
                cSuggestion.textContent = `Tip: ${better} is a better box size (FFT friendly). Click to set.`;
                cSuggestion.onclick = () => { cFcBox.value = better; updateCryo(); };
            } else {
                cSuggestion.textContent = '';
            }
        }

        cTargetRes.addEventListener('input', () => {
             const targetNyq = parseFloat(cTargetRes.value);
             const rawPix = parseFloat(cPix.value);
             const rawBox = parseFloat(cBox.value);

             if(targetNyq && rawPix && rawBox){
                 let reqBox = (rawPix * rawBox * 2) / targetNyq;
                 reqBox = findNextGoodBox(reqBox);
                 if(reqBox > rawBox) reqBox = rawBox;
                 cFcBox.value = reqBox;
                 updateCryo();
             }
        });

        cFcBox.addEventListener('input', () => {
             const rawBox = parseFloat(cBox.value);
             const fc = parseFloat(cFcBox.value);
             if(rawBox && fc) cBin.value = (rawBox/fc).toFixed(3);
             updateCryo();
        });

        cBin.addEventListener('input', () => {
             const rawBox = parseFloat(cBox.value);
             const b = parseFloat(cBin.value);
             if(rawBox && b) cFcBox.value = Math.round(rawBox/b);
             updateCryo();
        });

        [cPix, cBox].forEach(el => el.addEventListener('input', updateCryo));

        // --- Utilities ---
        // Dilution
        const dM1 = document.getElementById('util-dil-m1');
        const dV1 = document.getElementById('util-dil-v1');
        const dM2 = document.getElementById('util-dil-m2');
        const dV2 = document.getElementById('util-dil-v2');
        const dRes = document.getElementById('util-dil-res');

        function calcDilution(){
             const m1 = parseFloat(dM1.value);
             const m2 = parseFloat(dM2.value);
             const v2 = parseFloat(dV2.value);
             if(m1 > 0 && m2 > 0 && v2 > 0){
                 const v1 = (m2 * v2) / m1;
                 dV1.value = v1.toFixed(3);
                 dRes.textContent = `Take ${v1.toFixed(3)} of Stock, add ${(v2-v1).toFixed(3)} diluent.`;
             } else dV1.value = '';
        }
        [dM1, dM2, dV2].forEach(el => el.addEventListener('input', calcDilution));

        // Molarity - SOLVER
        const mMw = document.getElementById('util-mol-mw');
        const mVol = document.getElementById('util-mol-vol');
        const mConc = document.getElementById('util-mol-conc');
        const mMass = document.getElementById('util-mol-mass');
        const mSolve = document.getElementById('util-mol-solve');

        const mVolUnit = document.getElementById('util-mol-vol-unit');
        const mConcUnit = document.getElementById('util-mol-conc-unit');
        const mMassUnit = document.getElementById('util-mol-mass-unit');

        function updateSolverUI(){
            const target = mSolve.value;
            [mMw, mVol, mConc, mMass].forEach(el => {
                el.readOnly = false;
                el.classList.remove('bg-indigo-50', 'dark:bg-indigo-900/20', 'font-semibold');
                el.classList.add('bg-white', 'dark:bg-slate-900');
            });
            let elTarget;
            if(target === 'mass') elTarget = mMass;
            else if(target === 'conc') elTarget = mConc;
            else if(target === 'vol') elTarget = mVol;
            else if(target === 'mw') elTarget = mMw;
            if(elTarget){
                elTarget.readOnly = true;
                elTarget.classList.remove('bg-white', 'dark:bg-slate-900');
                elTarget.classList.add('bg-indigo-50', 'dark:bg-indigo-900/20', 'font-semibold');
            }
            solveMolarity();
        }

        function solveMolarity(){
            const target = mSolve.value;
            const mw = parseFloat(mMw.value);
            const units = {
                'kg': 1000, 'g': 1, 'mg': 1e-3, 'ug': 1e-6, 'ng': 1e-9, 'pg': 1e-12,
                'L': 1, 'mL': 1e-3, 'uL': 1e-6, 'nL': 1e-9, 'pL': 1e-12,
                'M': 1, 'mM': 1e-3, 'uM': 1e-6, 'nM': 1e-9, 'pM': 1e-12
            };
            const uVol = units[mVolUnit.value];
            const uConc = units[mConcUnit.value];
            const uMass = units[mMassUnit.value];

            const valVol = parseFloat(mVol.value);
            const valConc = parseFloat(mConc.value);
            const valMass = parseFloat(mMass.value);

            if(target === 'mass' && mw && valVol && valConc){
                const baseMass = (valConc * uConc) * (valVol * uVol) * mw;
                mMass.value = (baseMass / uMass).toPrecision(4);
            } else if (target === 'conc' && valMass && valVol && mw){
                const baseMass = valMass * uMass;
                const baseVol = valVol * uVol;
                const baseConc = baseMass / (mw * baseVol);
                mConc.value = (baseConc / uConc).toPrecision(4);
            } else if (target === 'vol' && valMass && valConc && mw){
                const baseMass = valMass * uMass;
                const baseConc = valConc * uConc;
                const baseVol = baseMass / (baseConc * mw);
                mVol.value = (baseVol / uVol).toPrecision(4);
            } else if (target === 'mw' && valMass && valConc && valVol){
                const baseMass = valMass * uMass;
                const baseConc = valConc * uConc;
                const baseVol = valVol * uVol;
                mMw.value = (baseMass / (baseConc * baseVol)).toFixed(2);
            }
        }

        mSolve.addEventListener('change', updateSolverUI);
        [mMw, mVol, mConc, mMass].forEach(el => el.addEventListener('input', solveMolarity));
        [mVolUnit, mConcUnit, mMassUnit].forEach(el => el.addEventListener('change', solveMolarity));
        updateSolverUI();

        // Centrifugation
        const cR = document.getElementById('util-cen-r');
        const cRpm = document.getElementById('util-cen-rpm');
        const cRcf = document.getElementById('util-cen-rcf');

        cRpm.addEventListener('input', () => {
            const r = parseFloat(cR.value);
            const rpm = parseFloat(cRpm.value);
            if(r && rpm){
                const g = 1.118e-5 * r * rpm * rpm;
                cRcf.value = Math.round(g);
                calcK();
            }
        });
        cRcf.addEventListener('input', () => {
            const r = parseFloat(cR.value);
            const g = parseFloat(cRcf.value);
            if(r && g){
                 const rpm = Math.sqrt( g / (1.118e-5 * r) );
                 cRpm.value = Math.round(rpm);
                 calcK();
            }
        });

        // K-Factor
        const cRmin = document.getElementById('cen-rmin');
        const cRmax = document.getElementById('cen-rmax');
        const cK = document.getElementById('cen-k');

        function calcK(){
            const rpm = parseFloat(cRpm.value);
            const min = parseFloat(cRmin.value);
            const max = parseFloat(cRmax.value);
            if(rpm && min && max && max > min){
                const k = (2.53e11 * Math.log(max/min)) / (rpm * rpm);
                cK.textContent = Math.round(k);
            } else cK.textContent = "--";
        }
        [cRmin, cRmax, cR].forEach(el => el.addEventListener('input', calcK));

        // --- MASTER MIX LOGIC ---
        const mmRows = document.getElementById('mm-rows');
        const mmAdd = document.getElementById('mm-add-btn');
        const mmResult = document.getElementById('mm-result');
        const inputsMM = ['mm-vol', 'mm-n', 'mm-excess', 'mm-dead'];

        function createMMRow(name='Reagent', vol=1){
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center";
            div.innerHTML = `
                <input type="text" value="${name}" class="mm-name flex-1 p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-xs text-slate-900 dark:text-slate-100" placeholder="Name">
                <input type="number" value="${vol}" step="any" class="mm-one-vol w-20 p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-xs text-right text-slate-900 dark:text-slate-100" placeholder="1x">
                <span class="text-xs text-gray-400">ŒºL</span>
                <button class="text-red-400 hover:text-red-600 px-2">√ó</button>
            `;
            div.querySelector('button').onclick = () => { div.remove(); calcMM(); };
            div.querySelectorAll('input').forEach(i => i.addEventListener('input', calcMM));
            return div;
        }

        function calcMM(){
            const N = parseFloat(document.getElementById('mm-n').value) || 1;
            const exc = parseFloat(document.getElementById('mm-excess').value) || 0;
            const dead = parseFloat(document.getElementById('mm-dead').value) || 0;
            const targetVol = parseFloat(document.getElementById('mm-vol').value) || 0;

            const totalRxns = N * (1 + exc/100);
            document.getElementById('mm-total-n').textContent = totalRxns.toFixed(1);

            let currentVol = 0;
            let html = '';

            mmRows.querySelectorAll('div.flex').forEach(row => {
                const name = row.querySelector('.mm-name').value;
                const oneVol = parseFloat(row.querySelector('.mm-one-vol').value) || 0;
                const totalVolReq = (targetVol * totalRxns) + dead;
                const totVol = targetVol > 0 ? (oneVol / targetVol) * totalVolReq : 0;
                currentVol += oneVol;
                html += `<li class="flex justify-between border-b border-dotted border-gray-200 dark:border-gray-700"><span>${name}</span><span>${totVol.toFixed(1)} ŒºL</span></li>`;
            });

            const water = targetVol - currentVol;
            if(water >= 0){
                const totalVolReq = (targetVol * totalRxns) + dead;
                const waterTot = targetVol > 0 ? (water / targetVol) * totalVolReq : 0;
                html += `<li class="flex justify-between text-indigo-600 dark:text-indigo-400 font-semibold"><span>Water</span><span>${waterTot.toFixed(1)} ŒºL</span></li>`;
                if(dead > 0) html += `<li class="text-[10px] text-gray-400 text-right mt-1">Includes ${dead}ŒºL dead vol</li>`;
            } else {
                html += `<li class="text-red-500 text-xs">Error: Volumes exceed ${targetVol}ŒºL</li>`;
            }
            mmResult.innerHTML = html;
        }

        inputsMM.forEach(id => document.getElementById(id).addEventListener('input', calcMM));
        mmAdd.addEventListener('click', () => { mmRows.appendChild(createMMRow()); calcMM(); });
        mmRows.appendChild(createMMRow("Buffer (10x)", 2));
        mmRows.appendChild(createMMRow("Enzyme", 0.5));
        mmRows.appendChild(createMMRow("Template", 1));
        calcMM();

        // --- AMMONIUM SULFATE LOGIC ---
        const asIds = ['as-vol', 'as-s1', 'as-s2', 'as-temp'];
        asIds.forEach(id => document.getElementById(id).addEventListener('input', calcAS));

        function calcAS(){
            const v = parseFloat(document.getElementById('as-vol').value);
            const s1 = parseFloat(document.getElementById('as-s1').value);
            const s2 = parseFloat(document.getElementById('as-s2').value);
            const temp = document.getElementById('as-temp').value;

            if(v && !isNaN(s1) && s2){
                const factor = temp === "20" ? 533 : 516;
                const expansion = temp === "20" ? 0.3 : 0.27;
                if(s2 >= 100) { document.getElementById('as-result').textContent = "ERR"; return; }
                const numerator = factor * (s2 - s1);
                const denominator = 100 - (expansion * s2);
                const gPerL = numerator / denominator;
                const gFinal = gPerL * (v / 1000);
                document.getElementById('as-result').textContent = gFinal.toFixed(2);
            }
        }

        // --- SERIAL DILUTION LOGIC ---
        const sdIds = ['sd-factor', 'sd-vol'];
        sdIds.forEach(id => document.getElementById(id).addEventListener('input', calcSD));
        const sdPrepIds = ['sd-prep-stock-c', 'sd-prep-target-c', 'sd-prep-vol'];
        sdPrepIds.forEach(id => document.getElementById(id).addEventListener('input', calcSDPrep));

        function calcSDPrep(){
            const stockC = parseFloat(document.getElementById('sd-prep-stock-c').value);
            const targetC = parseFloat(document.getElementById('sd-prep-target-c').value);
            const targetV = parseFloat(document.getElementById('sd-prep-vol').value);
            if(stockC && targetC && targetV && stockC >= targetC){
                const vStock = (targetC * targetV) / stockC;
                const vBuf = targetV - vStock;
                document.getElementById('sd-prep-res-stock').textContent = vStock.toFixed(1) + ' ŒºL';
                document.getElementById('sd-prep-res-buf').textContent = vBuf.toFixed(1) + ' ŒºL';
            } else {
                document.getElementById('sd-prep-res-stock').textContent = '--';
                document.getElementById('sd-prep-res-buf').textContent = '--';
            }
        }

        function calcSD(){
            const factor = parseFloat(document.getElementById('sd-factor').value);
            const vFinal = parseFloat(document.getElementById('sd-vol').value);
            if(factor > 1 && vFinal > 0){
                const vTrans = vFinal / (factor - 1);
                document.getElementById('sd-diluent').textContent = vFinal + " ŒºL";
                document.getElementById('sd-transfer').textContent = vTrans.toFixed(1) + " ŒºL";
                drawSDSchematic(vFinal, vTrans, factor);
            }
        }

        function drawSDSchematic(vWell, vTrans, factor){
             const container = document.getElementById('sd-schematic');
             container.innerHTML = '';
             for(let i=1; i<=4; i++){
                 const tube = document.createElement('div');
                 tube.className = "flex flex-col items-center min-w-[60px]";
                 const isFirst = i===1;
                 tube.innerHTML = `
                    <div class="mb-1 text-[10px] text-gray-500 font-mono">1:${Math.pow(factor, i-1)}</div>
                    <div class="relative w-10 h-16 border-2 border-gray-300 dark:border-gray-600 rounded-b-lg bg-white dark:bg-slate-800 overflow-hidden">
                        <div class="absolute bottom-0 w-full bg-indigo-200 dark:bg-indigo-900/50 transition-all" style="height: 60%"></div>
                    </div>
                    <div class="mt-1 text-[10px] text-center text-gray-400">
                        ${isFirst ? 'Start Mix' : '+'+vTrans.toFixed(1)+'ŒºL'}
                    </div>
                 `;
                 if(!isFirst){
                     const arrow = document.createElement('div');
                     arrow.className = "mb-8 mx-1 text-gray-400 text-xs font-mono relative";
                     arrow.innerHTML = `<span class="absolute -top-3 left-1/2 -translate-x-1/2 whitespace-nowrap">${vTrans.toFixed(0)}ŒºL</span>‚Üí`;
                     container.appendChild(arrow);
                 }
                 container.appendChild(tube);
             }
        }

        // --- SEQUENCE VIEWER LOGIC ---
        const svInput = document.getElementById('sv-seq-input');
        const svOutput = document.getElementById('sv-output');
        const svStart = document.getElementById('sv-hl-start');
        const svEnd = document.getElementById('sv-hl-end');
        const svAddHl = document.getElementById('sv-add-hl');
        const svClearHl = document.getElementById('sv-clear-hl');
        const svShowFeats = document.getElementById('sv-show-feats');
        const svHlList = document.getElementById('sv-hl-list');
        const svRowLen = document.getElementById('sv-row-len');
        const svColorMode = document.getElementById('sv-color-mode');
        const svFeatsPanel = document.getElementById('sv-features-panel');
        const svFeatsList = document.getElementById('sv-features-list');
        const svSelStats = document.getElementById('sv-sel-stats');

        let svUserHighlights = []; // {start, end, color}
        let svFeatureHighlights = []; // {start, end, color, label, category, enabled}

        // Color Helper (from React part)
        const getResidueColor = (char, mode) => {
            if (char === '-') return 'bg-gray-100 text-gray-400 dark:bg-gray-700 dark:text-gray-500';
            // Protein (Physicochemical properties)
            // Hydrophobic (ILVAM) - Pink
            if (['I','L','V','A','M'].includes(char)) {
                if(mode==='hydro') return 'bg-pink-200 text-pink-900 dark:bg-pink-800 dark:text-pink-100';
                if(mode==='type') return 'bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200';
            }
            // Aromatic (FWY) - Orange
            if (['F','W','Y'].includes(char)) {
                if(mode==='hydro') return 'bg-orange-200 text-orange-900 dark:bg-orange-800 dark:text-orange-100';
                if(mode==='type') return 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200';
            }
            // Positive (KRH) - Blue
            if (['K','R','H'].includes(char)) return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
            // Negative (DE) - Red
            if (['D','E'].includes(char)) return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
            // Polar (STNQ) - Green
            if (['S','T','N','Q'].includes(char)) return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
            // Proline/Glycine (Special)
            if (['P','G'].includes(char)) return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
            // Cysteine
            if (char === 'C') return 'bg-yellow-200 text-yellow-900 border border-yellow-300 dark:bg-yellow-600 dark:text-yellow-100 dark:border-yellow-500';

            return ''; // Default
        };

        function svRender() {
            const raw = svInput.value;
            const seq = raw.replace(/[^A-Za-z*]/g, '');
            svOutput.innerHTML = '';

            if(!seq) {
                svOutput.innerHTML = '<div class="text-gray-400 italic">Enter sequence above.</div>';
                return;
            }

            const charsPerLine = parseInt(svRowLen.value) || 60;
            const lines = Math.ceil(seq.length / charsPerLine);
            const colorMode = svColorMode.value;

            for(let i=0; i<lines; i++) {
                const startIdx = i * charsPerLine;
                const lineSeq = seq.substr(startIdx, charsPerLine);

                const lineContainer = document.createElement('div');
                lineContainer.className = "mb-6 relative font-mono text-sm leading-none";

                // Ladder
                const ladder = document.createElement('div');
                ladder.className = "select-none text-gray-400 mb-1 pointer-events-none whitespace-pre";

                let numLine = " ".repeat(lineSeq.length);
                for(let k=10; k<=seq.length; k+=10) {
                    if(k > startIdx && k <= startIdx + charsPerLine) {
                        const s = k.toString();
                        const pos = k - startIdx - 1;
                         const insertAt = pos - s.length + 1;
                         if(insertAt >= 0) {
                            // Add extra padding to align correctly if blocks used?
                            // Ladder logic assumes 1 char = 1 space.
                            numLine = numLine.substring(0, insertAt) + s + numLine.substring(pos+1);
                         }
                    }
                }
                // Add spaces for blocks of 10 if needed?
                // The user asked for "without enters/spaces just sequence" copy.
                // Current implementation of ladder adds spaces to `numLine` string.
                // Current implementation of `formatBlock` adds spaces to sequence.
                // We should separate visual spacing from content if we want 100% clean copy by default,
                // BUT user highlights rely on character positions.
                // Let's stick to adding spaces for readability but use `user-select: none` on spacers if possible,
                // OR just handle the copy event interception which covers it.
                // I will continue using `formatBlock` visual style but implemented via spans.

                const formatBlockSpaced = (s) => s.match(/.{1,10}/g).join(' ');
                ladder.textContent = formatBlockSpaced(numLine);
                lineContainer.appendChild(ladder);

                // Sequence Text Container
                const textDiv = document.createElement('div');
                textDiv.className = "relative z-10 break-all whitespace-pre";

                // Render Residues
                let renderedSeq = "";
                for(let j=0; j<lineSeq.length; j++) {
                    const char = lineSeq[j];
                    if(j > 0 && j % 10 === 0) {
                        const spacer = document.createElement('span');
                        spacer.textContent = ' ';
                        // spacer.className = 'select-none'; // Better for copy? No, copy handler handles it.
                        textDiv.appendChild(spacer);
                    }
                    const span = document.createElement('span');
                    span.textContent = char;
                    if(colorMode !== 'none') {
                        span.className = `inline-block border-y border-transparent ${getResidueColor(char, colorMode)}`;
                    }
                    textDiv.appendChild(span);
                }
                lineContainer.appendChild(textDiv);

                // Highlights Layer
                const allHl = [...svUserHighlights];
                if(svShowFeats.checked) {
                    // Only include enabled features
                    allHl.push(...svFeatureHighlights.filter(f => f.enabled !== false));
                }

                allHl.forEach(h => {
                    const hStart = Math.max(h.start, startIdx + 1);
                    const hEnd = Math.min(h.end, startIdx + charsPerLine);

                    if(hStart <= hEnd) {
                        const localStart = hStart - startIdx - 1;
                        const localEnd = hEnd - startIdx - 1;

                        const spacesBeforeStart = Math.floor(localStart / 10);
                        const visualStart = localStart + spacesBeforeStart;

                        const spacesBeforeEnd = Math.floor(localEnd / 10);
                        const visualEnd = localEnd + spacesBeforeEnd;

                        const width = visualEnd - visualStart + 1;

                        const hlRect = document.createElement('div');
                        hlRect.className = "absolute pointer-events-none z-0";
                        hlRect.style.backgroundColor = h.color || 'yellow';
                        hlRect.style.opacity = '0.3';
                        hlRect.style.left = `${visualStart}ch`;
                        hlRect.style.width = `${width}ch`;
                        hlRect.style.top = "1.25rem"; // Approx
                        hlRect.style.height = "1.1em";
                        if(h.id) {
                            hlRect.dataset.featId = h.id; // For hover targeting
                            hlRect.title = `${h.label || 'Feature'} (${h.group || 'Region'})`;
                        } else {
                            hlRect.title = "User Region";
                        }
                        lineContainer.appendChild(hlRect);
                    }
                });

                svOutput.appendChild(lineContainer);
            }
            svUpdateLegend(colorMode);
        }

        function svUpdateLegend(mode) {
            const el = document.getElementById('sv-legend');
            if(mode === 'none') { el.innerHTML = ''; el.classList.add('hidden'); return; }
            el.classList.remove('hidden');
            let html = '<span class="font-bold mr-2">Key:</span>';
            if(mode === 'type') {
                html += '<span class="bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200 px-1 rounded mr-1">Hydrophobic</span>';
                html += '<span class="bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200 px-1 rounded mr-1">Aromatic</span>';
                html += '<span class="bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 px-1 rounded mr-1">Positive</span>';
                html += '<span class="bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 px-1 rounded mr-1">Negative</span>';
                html += '<span class="bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-1 rounded mr-1">Polar</span>';
                html += '<span class="bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 px-1 rounded mr-1">P/G</span>';
                html += '<span class="bg-yellow-200 text-yellow-900 dark:bg-yellow-600 dark:text-yellow-100 px-1 rounded mr-1">Cys</span>';
            } else if (mode === 'charge') {
                html += '<span class="bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 px-1 rounded mr-1">Positive (KRH)</span>';
                html += '<span class="bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 px-1 rounded mr-1">Negative (DE)</span>';
            } else if (mode === 'hydro') {
                html += '<span class="bg-pink-200 text-pink-900 dark:bg-pink-800 dark:text-pink-100 px-1 rounded mr-1">Hydrophobic (ILVAM)</span>';
                html += '<span class="bg-orange-200 text-orange-900 dark:bg-orange-800 dark:text-orange-100 px-1 rounded mr-1">Aromatic (FWY)</span>';
            }
            el.innerHTML = html;
        }

        function svAddUserHighlight() {
            const s = parseInt(svStart.value);
            const e = parseInt(svEnd.value);
            if(s && e && s<=e) {
                const color = document.getElementById('sv-hl-color').value;
                svUserHighlights.push({start: s, end: e, color});
                svUpdateList();
                svRender();
            }
        }

        function svUpdateList() {
            svHlList.innerHTML = '';
            svUserHighlights.forEach((h, idx) => {
                const tag = document.createElement('div');
                tag.className = "text-xs px-2 py-1 rounded flex items-center gap-1 border border-gray-200 dark:border-gray-600 dark:text-slate-100";
                tag.style.background = h.color;
                tag.style.color = '#1f2937';
                tag.innerHTML = `<span>${h.start}-${h.end}</span> <button class="ml-1 font-bold hover:text-red-700">√ó</button>`;
                tag.querySelector('button').onclick = () => {
                    svUserHighlights.splice(idx, 1);
                    svUpdateList();
                    svRender();
                };
                svHlList.appendChild(tag);
            });
        }

        function svScanFeatures() {
            if(!svShowFeats.checked) {
                svFeatsPanel.classList.add('hidden');
                svRender();
                return;
            }
            const seq = svInput.value.replace(/[^A-Za-z*]/g, '').toUpperCase();
            if(!window.PROTEIN_DEFS || !window.PROTEIN_DEFS.TAGS) return;

            // Preserve enabled state if re-scanning
            const oldState = {};
            svFeatureHighlights.forEach(f => { if(f.group) oldState[f.group] = f.enabled; });

            svFeatureHighlights = [];
            const TAGS = window.PROTEIN_DEFS.TAGS;
            const MOTIFS = window.PROTEIN_DEFS.MOTIFS;

            for(const name in TAGS) {
                const def = TAGS[name];
                def.seqs.forEach(pattern => {
                    let idx = seq.indexOf(pattern);
                    while(idx !== -1) {
                         svFeatureHighlights.push({
                             id: 'feat-' + Math.random().toString(36).substr(2,9),
                             start: idx + 1,
                             end: idx + pattern.length,
                             color: def.color,
                             label: name,
                             group: name,
                             category: def.category,
                             enabled: oldState[name] !== false
                         });
                         idx = seq.indexOf(pattern, idx+1);
                    }
                });
            }

            MOTIFS.forEach(m => {
                const re = new RegExp(m.regex.source, 'g');
                let match;
                while((match = re.exec(seq)) !== null) {
                    svFeatureHighlights.push({
                        id: 'feat-' + Math.random().toString(36).substr(2,9),
                        start: match.index + 1,
                        end: match.index + match[0].length,
                        color: m.color,
                        label: m.name,
                        group: m.name,
                        category: m.category,
                        enabled: oldState[m.name] !== false
                    });
                }
            });

            // Update Panel
            svFeatsPanel.classList.remove('hidden');
            svFeatsList.innerHTML = '';

            // Group by name
            const groups = {};
            svFeatureHighlights.forEach(f => {
                if(!groups[f.label]) groups[f.label] = { count:0, color: f.color, enabled: f.enabled, ids: [] };
                groups[f.label].count++;
                groups[f.label].ids.push(f.id);
            });

            Object.keys(groups).sort().forEach(label => {
                const g = groups[label];
                const div = document.createElement('div');
                div.className = "flex items-center gap-2 p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors";

                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.checked = g.enabled;
                chk.className = "rounded text-indigo-600 focus:ring-indigo-500 dark:bg-slate-800 dark:border-gray-600";
                chk.onchange = (e) => {
                    svFeatureHighlights.forEach(f => { if(f.label === label) f.enabled = e.target.checked; });
                    svRender();
                };

                const span = document.createElement('span');
                span.className = "flex-1 cursor-pointer truncate";
                span.innerHTML = `<span class="inline-block w-2 h-2 rounded-full mr-1" style="background:${g.color}"></span> ${label} <span class="text-gray-400">(${g.count})</span>`;

                // Hover effect
                div.addEventListener('mouseenter', () => {
                    g.ids.forEach(id => {
                        const el = svOutput.querySelector(`div[data-feat-id="${id}"]`);
                        if(el) {
                            el.style.opacity = '0.6';
                            el.style.border = '2px solid rgba(0,0,0,0.5)';
                            el.style.zIndex = '5';
                        }
                    });
                });
                div.addEventListener('mouseleave', () => {
                    g.ids.forEach(id => {
                        const el = svOutput.querySelector(`div[data-feat-id="${id}"]`);
                        if(el) {
                            el.style.opacity = '0.3';
                            el.style.border = 'none';
                            el.style.zIndex = '0';
                        }
                    });
                });

                div.prepend(chk);
                div.appendChild(span);
                svFeatsList.appendChild(div);
            });

            svRender();
        }

        // Selection & Copy
        document.addEventListener('selectionchange', () => {
            const sel = window.getSelection();
            if(!sel.rangeCount) return;
            if(!svOutput.contains(sel.anchorNode)) {
                // Check if we just left? Maybe keep stats visible?
                // Better to hide if selection is elsewhere
                // svSelStats.classList.add('hidden');
                return;
            }

            const txt = sel.toString();
            // Clean: remove non-AA (spaces, newlines, numbers from ladder if accidentally selected)
            // Note: Since ladder is select-none, numbers shouldn't be here mostly.
            const clean = txt.replace(/[^A-Za-z*]/g, '');

            if(clean.length > 0) {
                svSelStats.classList.remove('hidden');
                document.getElementById('sv-sel-len').textContent = clean.length;

                // Calc stats
                if(PROT_UTILS.countAA && PROT_UTILS.molecularWeight) {
                    const counts = PROT_UTILS.countAA(clean);
                    const mw = PROT_UTILS.molecularWeight(counts);
                    document.getElementById('sv-sel-mw').textContent = mw.toFixed(2);

                    if(PROT_UTILS.extinctionCoefficients) {
                        const ext = PROT_UTILS.extinctionCoefficients(counts, mw);
                        document.getElementById('sv-sel-ext').textContent = ext.reduced;
                    }

                    if(PROT_UTILS.netCharge) {
                        const chg = PROT_UTILS.netCharge(counts, 7.4); // pH 7.4 default
                        document.getElementById('sv-sel-chg').textContent = chg.toFixed(2);
                    }
                }
            } else {
                svSelStats.classList.add('hidden');
            }
        });

        svOutput.addEventListener('copy', (e) => {
            const sel = window.getSelection();
            if(svOutput.contains(sel.anchorNode)) {
                e.preventDefault();
                const clean = sel.toString().replace(/[^A-Za-z*]/g, '');
                if(e.clipboardData) {
                    e.clipboardData.setData('text/plain', clean);
                }
            }
        });

        document.getElementById('sv-uncheck-all').addEventListener('click', () => {
             svFeatureHighlights.forEach(f => f.enabled = false);
             svFeatsList.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
             svRender();
        });

        svInput.addEventListener('input', () => { svRender(); if(svShowFeats.checked) svScanFeatures(); });
        svAddHl.addEventListener('click', svAddUserHighlight);
        svClearHl.addEventListener('click', () => { svUserHighlights = []; svUpdateList(); svRender(); });
        svShowFeats.addEventListener('change', svScanFeatures);
        svRowLen.addEventListener('input', svRender);
        svColorMode.addEventListener('change', svRender);

    }
})();
</script>
