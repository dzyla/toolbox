<div class="mx-auto max-w-6xl p-4 md:p-8">
  <header class="mb-6">
    <div class="flex items-center justify-between gap-3 flex-wrap">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900 dark:text-slate-100">Bio-Bench</h1>
        <p class="mt-1 text-slate-600 dark:text-slate-400 text-sm md:text-base">Laboratory Utilities & Reference Tools</p>
      </div>
    </div>
  </header>

  <!-- Enforce Tailwind Config here too (safe to repeat or index.html handles it) -->
  <script>
    if (!window.tailwind || !window.tailwind.configLoadedOnce) {
       window.tailwind = window.tailwind || {};
       window.tailwind.config = { darkMode: 'class' };
       window.tailwind.configLoadedOnce = true;
    }
  </script>

  <!-- Navigation Tabs -->
  <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" id="bb-tabs">
      <button class="bb-tab active border-indigo-500 text-indigo-600 dark:text-indigo-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-buffer">
        üß™ Buffer Mixer
      </button>
      <button class="bb-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-macro">
        üß¨ Macromolecules
      </button>
      <button class="bb-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-cryo">
        ‚ùÑÔ∏è Cryo-EM Suite
      </button>
      <button class="bb-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-utils">
        üìê Lab Utilities
      </button>
      <button class="bb-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-reactions">
        üß™ Master Mix
      </button>
      <button class="bb-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="tab-purify">
        üßº Purification
      </button>
    </nav>
  </div>

  <!-- Tab Contents -->
  <div id="bb-content">

    <!-- Buffer Mixer -->
    <div id="tab-buffer" class="bb-pane block space-y-6">
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
        <h3 class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Buffer Recipe Calculator</h3>

        <div class="space-y-4" id="buffer-rows">
           <!-- Dynamic Rows -->
        </div>

        <!-- pH Adjustment Helper -->
        <details class="bg-slate-50 dark:bg-slate-900/50 rounded-lg p-3 border border-slate-100 dark:border-slate-800 mt-2">
            <summary class="text-xs font-semibold text-gray-500 cursor-pointer">pH Adjustment Calculator</summary>
            <div class="mt-2 grid grid-cols-3 gap-2 items-end">
                <div>
                    <label class="block text-[10px] text-gray-400">Target pH</label>
                    <input type="number" id="ph-target" class="w-full p-1 border rounded text-xs bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100 border-gray-300 dark:border-gray-600" step="0.1" placeholder="7.4">
                </div>
                <div>
                    <label class="block text-[10px] text-gray-400">pKa</label>
                    <input type="number" id="ph-pka" class="w-full p-1 border rounded text-xs bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100 border-gray-300 dark:border-gray-600" step="0.1" placeholder="e.g. 7.5">
                </div>
                <div class="text-xs text-gray-500 pb-1" id="ph-ratio-out">
                    Ratio (Base/Acid): --
                </div>
            </div>
        </details>

        <div class="flex gap-3 mt-4">
           <button id="add-component-btn" class="text-sm bg-white hover:bg-gray-50 dark:bg-slate-700 dark:hover:bg-slate-600 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-slate-100 px-3 py-2 rounded-lg">
             + Add Component
           </button>
        </div>

        <div class="mt-6 pt-4 border-t border-gray-100 dark:border-gray-700">
           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                 <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Total Volume</label>
                 <div class="flex gap-2">
                    <input type="number" id="buffer-total-vol" value="1" class="w-full p-2 border rounded-lg bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100 border-gray-300 dark:border-gray-600">
                    <select id="buffer-total-unit" class="p-2 border rounded-lg bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100 border-gray-300 dark:border-gray-600">
                       <option value="L">L</option>
                       <option value="mL">mL</option>
                    </select>
                 </div>
              </div>
              <div class="flex items-end">
                 <div class="text-sm text-gray-500 dark:text-gray-400">
                    Calculations update automatically.
                 </div>
              </div>
           </div>
        </div>

        <div class="mt-6 bg-slate-50 dark:bg-slate-900/50 rounded-lg p-4 border border-slate-100 dark:border-slate-800">
            <div class="flex justify-between items-center mb-2">
                <h4 class="font-medium text-slate-900 dark:text-slate-100">Recipe Checklist</h4>
                <div class="flex gap-2">
                    <button id="btn-print-table" class="text-xs text-slate-600 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 border border-gray-300 dark:border-slate-600 px-2 py-1 rounded bg-white dark:bg-slate-800">
                        üñ®Ô∏è Print Table
                    </button>
                    <button id="btn-export-recipe" class="text-xs text-indigo-500 hover:text-indigo-700 dark:hover:text-indigo-400 border border-indigo-200 dark:border-slate-700 px-2 py-1 rounded">
                        üìã Export Markdown
                    </button>
                </div>
            </div>
            <ul id="buffer-recipe-list" class="space-y-2 text-sm text-slate-700 dark:text-slate-300">
               <li class="italic text-gray-400">Add components to generate recipe.</li>
            </ul>
        </div>
      </div>
    </div>

    <!-- Macromolecule Converter -->
    <div id="tab-macro" class="bb-pane hidden space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
         <!-- Protein Tool -->
         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Protein Concentration</h3>
            <div class="space-y-3">
               <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Protein Sequence (for MW & Œµ)</label>
                  <textarea id="macro-prot-seq" rows="3" class="w-full p-2 border rounded-lg font-mono text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="MSTRSV..."></textarea>
               </div>
               <div class="grid grid-cols-2 gap-3">
                  <div>
                      <label class="block text-xs text-gray-500 dark:text-gray-400">MW (kDa)</label>
                      <input type="number" id="macro-prot-mw" step="0.1" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                       <input type="hidden" id="macro-prot-base-mw"> <!-- Hidden store for sequence-only MW -->
                  </div>
                  <div>
                      <label class="block text-xs text-gray-500 dark:text-gray-400">Œµ<sub>280</sub> (M‚Åª¬πcm‚Åª¬π)</label>
                      <input type="number" id="macro-prot-eps" step="10" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                  </div>
               </div>
               <!-- Extinction Variants -->
               <div class="flex gap-2 text-[10px] justify-end -mt-2 mb-2">
                   <span class="text-gray-400">Set Œµ:</span>
                   <button id="btn-eps-red" class="text-indigo-500 hover:underline" title="Reduced (No S-S)">Red: <span id="val-eps-red">--</span></button>
                   <span class="text-gray-300">|</span>
                   <button id="btn-eps-ox" class="text-indigo-500 hover:underline" title="Oxidized (All Cys as S-S)">Ox: <span id="val-eps-ox">--</span></button>
               </div>

               <!-- ADDED Abs 0.1% Field -->
               <div class="grid grid-cols-2 gap-3">
                  <div>
                      <label class="block text-xs text-gray-500 dark:text-gray-400">Abs 0.1% (=1 g/L)</label>
                      <input type="number" id="macro-prot-abs-percent" step="0.01" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="e.g. 1.0">
                  </div>
                  <div class="flex items-end text-xs text-gray-400 pb-2">
                      (Approx based on Œµ & MW)
                  </div>
               </div>

               <!-- Modifications Section -->
               <details class="group bg-slate-50 dark:bg-slate-900/50 rounded-lg p-3 border border-slate-100 dark:border-slate-800">
                   <summary class="text-xs font-semibold text-gray-600 dark:text-gray-400 cursor-pointer list-none flex items-center gap-2">
                       <span class="group-open:rotate-90 transition-transform">‚ñ∂</span>
                       Modifications & Glycosylation
                   </summary>
                   <div class="mt-3 space-y-3">
                       <!-- Glycosylation -->
                       <div>
                           <label class="block text-[10px] uppercase text-gray-400 tracking-wide mb-1">Glycosylation</label>
                           <div class="grid grid-cols-[1fr,1.5fr,1fr] gap-2 items-center">
                               <input type="number" id="mod-glyco-n" class="w-full p-1 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600" placeholder="Count (n)">
                               <select id="mod-glyco-type" class="w-full p-1 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                                   <option value="1.5">N-Link (High Man) ~1.5k</option>
                                   <option value="2.5">N-Link (Complex) ~2.5k</option>
                                   <option value="0.365">O-Link (Core 1) ~0.37k</option>
                                   <option value="custom">Custom</option>
                               </select>
                               <div class="relative">
                                   <input type="number" id="mod-glyco-mass" step="0.1" class="w-full p-1 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600" value="1.5">
                                   <span class="absolute right-1 top-1 text-[10px] text-gray-400">kDa</span>
                               </div>
                           </div>
                       </div>
                       <!-- Phosphorylation -->
                       <div>
                            <label class="block text-[10px] uppercase text-gray-400 tracking-wide mb-1">Phosphorylation (+80 Da)</label>
                            <div class="flex gap-2 items-center">
                                <input type="number" id="mod-phos-n" class="w-20 p-1 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600" placeholder="Count">
                                <span class="text-xs text-gray-500">sites</span>
                            </div>
                       </div>
                       <!-- Other Custom -->
                       <div>
                            <label class="block text-[10px] uppercase text-gray-400 tracking-wide mb-1">Other (Custom)</label>
                            <div class="grid grid-cols-[1fr,2fr] gap-2 items-center">
                                <input type="number" id="mod-other-n" class="w-full p-1 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600" placeholder="Count">
                                <div class="relative">
                                    <input type="number" id="mod-other-mass" step="0.1" class="w-full p-1 border rounded text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600" placeholder="Mass">
                                    <span class="absolute right-1 top-1 text-[10px] text-gray-400">kDa</span>
                                </div>
                            </div>
                       </div>
                       <div class="text-[10px] text-right text-indigo-500" id="mod-total-display">
                           Mods: +0.00 kDa
                       </div>
                   </div>
               </details>

               <hr class="border-gray-100 dark:border-gray-700 my-2">
               <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Absorbance (A<sub>280</sub>)</label>
                  <input type="number" id="macro-prot-a280" step="0.01" placeholder="e.g. 0.5" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
               </div>
               <div class="grid grid-cols-2 gap-3 bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-lg">
                   <div>
                       <div class="text-xs text-indigo-600 dark:text-indigo-300 font-semibold">Conc (mg/mL)</div>
                       <input type="number" id="macro-prot-res-mgml-in" class="w-full bg-transparent border-0 border-b border-indigo-200 dark:border-indigo-700 text-lg font-mono text-slate-900 dark:text-slate-100 focus:ring-0 p-0" value="0.00">
                   </div>
                   <div>
                       <div class="text-xs text-indigo-600 dark:text-indigo-300 font-semibold">Conc (ŒºM)</div>
                       <div id="macro-prot-res-um" class="text-lg font-mono text-slate-900 dark:text-slate-100 pt-1">0.00</div>
                   </div>
               </div>
               <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                   Tip: Use <a href="#" class="text-indigo-500 hover:underline" onclick="document.getElementById('macro-prot-seq').value = 'MW'; document.getElementById('macro-prot-seq').dispatchEvent(new Event('input')); return false;">MW</a> as sequence to just set weight manually (not supported yet, edit inputs directly below). <br>
                   *Manual override of MW and Œµ allowed if sequence is empty.*
               </div>
            </div>
         </div>

         <!-- Nucleic Acid Tool -->
         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Nucleic Acids</h3>
            <div class="space-y-3">
               <div>
                   <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Type</label>
                   <select id="macro-na-type" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                       <option value="dsDNA">dsDNA (double-stranded)</option>
                       <option value="ssDNA">ssDNA (single-stranded/primer)</option>
                       <option value="ssRNA">ssRNA</option>
                   </select>
               </div>
               <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sequence (Optional for simple conc)</label>
                  <textarea id="macro-na-seq" rows="2" class="w-full p-2 border rounded-lg font-mono text-xs bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="ATGC..."></textarea>
               </div>

               <div class="grid grid-cols-2 gap-3">
                   <div>
                       <label class="block text-xs text-gray-500 dark:text-gray-400">Length (bp or nt)</label>
                       <input type="number" id="macro-na-len" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                   </div>
                   <div>
                       <label class="block text-xs text-gray-500 dark:text-gray-400">Approx MW (Da)</label>
                       <input type="number" id="macro-na-mw" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-slate-700 border-gray-200 dark:border-gray-600 text-slate-900 dark:text-slate-100" readonly>
                   </div>
               </div>

               <div class="grid grid-cols-2 gap-3">
                   <div>
                       <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Conc (ng/ŒºL)</label>
                       <input type="number" id="macro-na-ngul" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                   </div>
                   <div>
                       <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Result (nM)</label>
                       <input type="number" id="macro-na-nm" class="w-full p-2 border rounded-lg bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800 text-slate-900 dark:text-slate-100" readonly>
                   </div>
               </div>

               <div id="macro-na-tm-box" class="hidden mt-3 pt-3 border-t border-gray-100 dark:border-gray-700">
                   <div class="text-sm font-medium text-gray-700 dark:text-gray-300">Melting Temp (T<sub>m</sub>)</div>
                   <div class="text-xs text-gray-500 dark:text-gray-400">Based on 2¬∞(A-T) + 4¬∞(G-C) rule (< 14bp) or Wallace rule.</div>
                   <div class="mt-1 text-lg font-mono text-slate-900 dark:text-slate-100"><span id="macro-na-tm">--</span> ¬∞C</div>
               </div>
            </div>
         </div>
      </div>
    </div>

    <!-- Cryo-EM Suite -->
    <div id="tab-cryo" class="bb-pane hidden space-y-6">
       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
          <h3 class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Cryo-EM Parameters</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
             <div class="space-y-4">
                 <div>
                     <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Raw Pixel Size (√Ö/px)</label>
                     <input type="number" id="cryo-pix" step="0.001" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="e.g. 0.83">
                 </div>
                 <div>
                     <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Box Size (px)</label>
                     <input type="number" id="cryo-box" step="2" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="e.g. 256">
                 </div>

                 <!-- Fourier Crop Inputs -->
                 <div class="pt-2 border-t border-gray-100 dark:border-gray-700">
                     <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Target / Fourier Crop Box</label>
                     <input type="number" id="cryo-fc-box" step="2" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="e.g. 128">
                     <div id="cryo-box-suggestion" class="text-xs text-indigo-500 mt-1 cursor-pointer hover:underline"></div>
                 </div>

                 <div>
                     <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Binning Factor</label>
                     <input type="number" id="cryo-bin" step="0.01" value="1" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                 </div>

                 <!-- Max Res Helper -->
                 <div class="pt-2 border-t border-gray-100 dark:border-gray-700">
                     <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Target Nyquist (√Ö)</label>
                     <input type="number" id="cryo-target-res" step="0.1" class="w-full p-2 border rounded-lg bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100" placeholder="e.g. 3.5">
                     <p class="text-xs text-gray-400 mt-1">Updates crop box.</p>
                 </div>
             </div>

             <div class="col-span-2 bg-slate-50 dark:bg-slate-900/50 rounded-xl p-4 border border-slate-100 dark:border-slate-800">
                 <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">Comparison</h4>
                 <div class="overflow-x-auto">
                     <table class="w-full text-sm text-left">
                         <thead class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-gray-100 dark:bg-slate-800">
                             <tr>
                                 <th class="px-4 py-2 rounded-l-lg">Parameter</th>
                                 <th class="px-4 py-2">Raw (Unbinned)</th>
                                 <th class="px-4 py-2 rounded-r-lg">Binned / Cropped</th>
                             </tr>
                         </thead>
                         <tbody class="text-slate-700 dark:text-slate-300">
                             <tr class="border-b border-gray-200 dark:border-gray-700">
                                 <td class="px-4 py-3 font-medium">Pixel Size</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-pix-raw">--</td>
                                 <td class="px-4 py-3 font-mono font-bold text-indigo-600 dark:text-indigo-400" id="cryo-res-pix-bin">--</td>
                             </tr>
                             <tr class="border-b border-gray-200 dark:border-gray-700">
                                 <td class="px-4 py-3 font-medium">Nyquist (Res Limit)</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-nyq-raw">--</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-nyq-bin">--</td>
                             </tr>
                             <tr class="border-b border-gray-200 dark:border-gray-700">
                                 <td class="px-4 py-3 font-medium">Box Size (px)</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-box-raw">--</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-box-bin">--</td>
                             </tr>
                             <tr>
                                 <td class="px-4 py-3 font-medium">Physical Box Width</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-phys-raw">--</td>
                                 <td class="px-4 py-3 font-mono" id="cryo-res-phys-bin">--</td>
                             </tr>
                         </tbody>
                     </table>
                 </div>
             </div>
          </div>
       </div>
    </div>

    <!-- Lab Utilities -->
    <div id="tab-utils" class="bb-pane hidden space-y-6">
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

           <!-- Dilution Calc -->
           <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
               <h3 class="text-base font-semibold mb-3 text-slate-900 dark:text-slate-100">Dilution (M1V1 = M2V2)</h3>
               <div class="space-y-3 text-sm">
                   <div class="grid grid-cols-2 gap-2">
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Stock Conc (M1)</label>
                           <input type="number" id="util-dil-m1" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                       </div>
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Stock Vol (V1)</label>
                           <input type="number" id="util-dil-v1" class="w-full p-2 border rounded bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800 font-semibold" placeholder="?" readonly>
                       </div>
                   </div>
                   <div class="flex justify-center text-gray-400">‚Üì</div>
                   <div class="grid grid-cols-2 gap-2">
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Target Conc (M2)</label>
                           <input type="number" id="util-dil-m2" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                       </div>
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Target Vol (V2)</label>
                           <input type="number" id="util-dil-v2" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                       </div>
                   </div>
                   <div id="util-dil-res" class="p-2 bg-slate-50 dark:bg-slate-700 rounded text-xs text-center text-slate-700 dark:text-slate-300">
                       Enter M1, M2, V2 to calculate V1.
                   </div>
               </div>
           </div>

           <!-- Molarity Calc -->
           <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
               <h3 class="text-base font-semibold mb-3 text-slate-900 dark:text-slate-100">Molarity (Mass/Vol/MW)</h3>
               <div class="space-y-3 text-sm">
                   <!-- Updated to Reactive Solve-For Model -->
                   <div>
                       <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Solve For</label>
                       <select id="util-mol-solve" class="w-full p-2 border rounded bg-gray-50 dark:bg-slate-700 border-gray-300 dark:border-gray-600 text-slate-900 dark:text-slate-100">
                           <option value="mass">Mass (g)</option>
                           <option value="conc">Concentration (M)</option>
                           <option value="vol">Volume (L)</option>
                           <option value="mw">MW (g/mol)</option>
                       </select>
                   </div>
                   <hr class="border-gray-100 dark:border-gray-700">
                   <div>
                       <label class="block text-xs text-gray-500 dark:text-gray-400">MW (g/mol)</label>
                       <input type="number" id="util-mol-mw" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                   </div>
                   <div class="grid grid-cols-2 gap-2">
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Volume</label>
                           <div class="flex gap-1">
                               <input type="number" id="util-mol-vol" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                               <select id="util-mol-vol-unit" class="p-2 border rounded bg-gray-50 dark:bg-slate-800 text-xs">
                                   <option value="L">L</option>
                                   <option value="mL">mL</option>
                                   <option value="uL">¬µL</option>
                                   <option value="nL">nL</option>
                                   <option value="pL">pL</option>
                               </select>
                           </div>
                       </div>
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Conc</label>
                           <div class="flex gap-1">
                               <input type="number" id="util-mol-conc" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                               <select id="util-mol-conc-unit" class="p-2 border rounded bg-gray-50 dark:bg-slate-800 text-xs">
                                   <option value="M">M</option>
                                   <option value="mM">mM</option>
                                   <option value="uM">¬µM</option>
                                   <option value="nM">nM</option>
                                   <option value="pM">pM</option>
                               </select>
                           </div>
                       </div>
                   </div>
                   <div>
                       <label class="block text-xs text-gray-500 dark:text-gray-400">Mass</label>
                       <div class="flex gap-1">
                           <input type="number" id="util-mol-mass" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600" readonly>
                           <select id="util-mol-mass-unit" class="p-2 border rounded bg-gray-50 dark:bg-slate-800 text-xs">
                               <option value="kg">kg</option>
                               <option value="g" selected>g</option>
                               <option value="mg">mg</option>
                               <option value="ug">¬µg</option>
                               <option value="ng">ng</option>
                               <option value="pg">pg</option>
                           </select>
                       </div>
                   </div>
               </div>
           </div>

           <!-- Centrifugation -->
           <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
               <h3 class="text-base font-semibold mb-3 text-slate-900 dark:text-slate-100">RPM ‚Üî RCF (g)</h3>
               <div class="space-y-3 text-sm">
                   <div>
                       <label class="block text-xs text-gray-500 dark:text-gray-400">Rotor Radius (mm)</label>
                       <input type="number" id="util-cen-r" value="100" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                   </div>
                   <div class="grid grid-cols-2 gap-2 items-center">
                       <div>
                           <label class="block text-xs text-gray-500 dark:text-gray-400">Speed (RPM)</label>
                           <input type="number" id="util-cen-rpm" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                       </div>
                       <div class="text-center text-gray-400">‚Üî</div>
                   </div>
                   <div>
                        <label class="block text-xs text-gray-500 dark:text-gray-400">Force (RCF / g)</label>
                        <input type="number" id="util-cen-rcf" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                   </div>
                   <div class="text-xs text-gray-400 italic text-center mt-2">
                       g = (1.118 √ó 10‚Åª‚Åµ) √ó r √ó RPM¬≤
                   </div>
                   <div class="pt-2 border-t border-gray-100 dark:border-gray-700 mt-2">
                       <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">K-Factor Est.</label>
                       <div class="grid grid-cols-2 gap-2 mt-1">
                           <input type="number" id="cen-rmin" placeholder="Rmin (mm)" class="p-1 border rounded text-xs">
                           <input type="number" id="cen-rmax" placeholder="Rmax (mm)" class="p-1 border rounded text-xs">
                       </div>
                       <div class="mt-1 text-xs text-center font-mono">k = <span id="cen-k">--</span></div>
                   </div>
               </div>
           </div>

       </div>
    </div>

    <!-- Master Mix Calculator -->
    <div id="tab-reactions" class="bb-pane hidden space-y-6">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Reaction Master Mix</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Reaction Vol (ŒºL)</label>
                    <input type="number" id="mm-vol" value="20" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Sample Count (N)</label>
                    <input type="number" id="mm-n" value="10" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Excess (%)</label>
                    <input type="number" id="mm-excess" value="10" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600" title="Buffer for pipetting error">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Dead Vol (ŒºL)</label>
                    <input type="number" id="mm-dead" value="0" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600" title="Extra volume for troughs/robots">
                </div>
            </div>

            <div class="space-y-2 mb-4" id="mm-rows">
                <!-- Dynamic Rows -->
            </div>

            <button id="mm-add-btn" class="text-sm border border-dashed border-gray-400 text-gray-500 px-3 py-1 rounded hover:bg-gray-50 dark:hover:bg-slate-700 w-full">+ Add Reagent</button>

            <div class="mt-6 bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-indigo-700 dark:text-indigo-300">Total Master Mix</span>
                    <span class="text-xs text-indigo-600 dark:text-indigo-400">Make for <span id="mm-total-n">--</span> rxns</span>
                </div>
                <ul id="mm-result" class="text-sm space-y-1 font-mono text-slate-700 dark:text-slate-300"></ul>
            </div>
        </div>
    </div>

    <!-- Purification & Serial Dilution -->
    <div id="tab-purify" class="bb-pane hidden space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                <h3 class="text-lg font-semibold mb-3 text-slate-900 dark:text-slate-100">Ammonium Sulfate Cut</h3>
                <p class="text-xs text-gray-500 mb-4">Calculate solid (NH‚ÇÑ)‚ÇÇSO‚ÇÑ needed to reach target saturation.</p>

                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">Start Vol (mL)</label>
                            <input type="number" id="as-vol" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">Temp</label>
                            <select id="as-temp" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                                <option value="20">20¬∞C (Standard)</option>
                                <option value="4">4¬∞C (Cold Room)</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">Current %</label>
                            <input type="number" id="as-s1" value="0" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">Target %</label>
                            <input type="number" id="as-s2" value="30" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                        </div>
                    </div>

                    <div class="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-lg mt-4 border border-amber-100 dark:border-amber-800 text-center">
                        <div class="text-xs text-amber-800 dark:text-amber-400 uppercase tracking-wide font-semibold">Add Solid Salt</div>
                        <div class="text-2xl font-bold text-amber-600 dark:text-amber-500 my-1"><span id="as-result">0.0</span> g</div>
                        <div class="text-xs text-amber-700 dark:text-amber-400">Slowly, while stirring.</div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                <h3 class="text-lg font-semibold mb-3 text-slate-900 dark:text-slate-100">Serial Dilution</h3>

                <!-- Stock Prep Section -->
                <details class="mb-4 bg-indigo-50 dark:bg-indigo-900/20 rounded p-3 text-sm border border-indigo-100 dark:border-indigo-800" open>
                    <summary class="font-semibold text-indigo-700 dark:text-indigo-300 cursor-pointer text-xs uppercase tracking-wide">Preparation: First Well</summary>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <label class="block text-[10px] text-gray-500 dark:text-gray-400">Master Stock Conc</label>
                            <input type="number" id="sd-prep-stock-c" class="w-full p-1 border rounded bg-white dark:bg-slate-900 text-xs" placeholder="e.g. 100">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-500 dark:text-gray-400">Target Start Conc</label>
                            <input type="number" id="sd-prep-target-c" class="w-full p-1 border rounded bg-white dark:bg-slate-900 text-xs" placeholder="e.g. 10">
                        </div>
                    </div>
                    <div class="mt-2">
                         <label class="block text-[10px] text-gray-500 dark:text-gray-400">Required Start Volume (Well 1)</label>
                         <input type="number" id="sd-prep-vol" class="w-full p-1 border rounded bg-white dark:bg-slate-900 text-xs" value="200" placeholder="e.g. 200">
                    </div>
                    <div class="mt-2 text-xs font-mono text-center bg-white dark:bg-slate-900 p-2 rounded border border-gray-200 dark:border-gray-700">
                        Mix <span id="sd-prep-res-stock" class="font-bold text-indigo-600">--</span> Stock + <span id="sd-prep-res-buf" class="font-bold">--</span> Buffer
                    </div>
                </details>

                <hr class="border-gray-100 dark:border-gray-700 mb-4">

                <div class="space-y-3">
                     <div>
                        <label class="block text-xs text-gray-500 dark:text-gray-400">Desired Dilution Factor (e.g., 2 for 1:2)</label>
                        <input type="number" id="sd-factor" value="2" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                     </div>
                     <div>
                        <label class="block text-xs text-gray-500 dark:text-gray-400">Final Volume per Well (ŒºL)</label>
                        <input type="number" id="sd-vol" value="100" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600">
                     </div>

                     <div class="mt-4 p-3 bg-slate-50 dark:bg-slate-900/50 rounded border border-gray-200 dark:border-gray-700">
                         <div class="text-sm font-medium text-center mb-2">Pipetting Scheme</div>
                         <div class="flex justify-between text-xs mb-1">
                             <span>Diluent per well:</span>
                             <span class="font-mono font-bold" id="sd-diluent">-- ŒºL</span>
                         </div>
                         <div class="flex justify-between text-xs">
                             <span>Transfer volume:</span>
                             <span class="font-mono font-bold text-indigo-600 dark:text-indigo-400" id="sd-transfer">-- ŒºL</span>
                         </div>
                     </div>

                     <!-- Schematic Container -->
                     <div id="sd-schematic" class="flex gap-2 overflow-x-auto p-2 mt-4 items-end">
                         <!-- Visuals go here -->
                     </div>

                     <div class="text-xs text-gray-400 mt-2">
                         * Start with (Final Vol + Transfer Vol) in first tube.
                     </div>
                </div>
            </div>
        </div>
    </div>

  </div>
</div>

<script>
(function(){
    // --- Dependency Loading ---
    function loadScripts(srcs) {
        return Promise.all(srcs.map(src => {
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = src;
                s.onload = resolve;
                s.onerror = () => { console.warn("Failed to load "+src); resolve(); }; // Soft fail
                document.head.appendChild(s);
            });
        }));
    }

    // Ensure dependencies
    loadScripts(['labConstants.js', 'definitions.js']).then(() => {
        initBioBench();
    });

    function initBioBench(){
        const CONSTANTS = window.LAB_CONSTANTS || { chemicals: [] };

        // --- Tab Logic ---
        const tabs = document.querySelectorAll('.bb-tab');
        const panes = document.querySelectorAll('.bb-pane');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => {
                    t.classList.remove('active', 'border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400');
                    t.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400');
                });
                tab.classList.add('active', 'border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400');
                tab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400');

                const target = tab.dataset.target;
                panes.forEach(p => {
                    if(p.id === target) p.classList.remove('hidden');
                    else p.classList.add('hidden');
                });
            });
        });

        // --- pH Logic ---
        const phTarget = document.getElementById('ph-target');
        const phPka = document.getElementById('ph-pka');
        const phOut = document.getElementById('ph-ratio-out');

        function calcPH(){
            const ph = parseFloat(phTarget.value);
            const pka = parseFloat(phPka.value);
            if(ph && pka){
                // HH: pH = pKa + log([A-]/[HA])
                // pH - pKa = log(Ratio)
                // Ratio = 10^(pH - pKa)
                const r = Math.pow(10, ph - pka);
                phOut.textContent = `Ratio (Base/Acid): ${r.toFixed(2)}`;
            } else {
                phOut.textContent = "Ratio (Base/Acid): --";
            }
        }
        phTarget.addEventListener('input', calcPH);
        phPka.addEventListener('input', calcPH);

        // --- Buffer Mixer Logic ---
        const bufferRows = document.getElementById('buffer-rows');
        const addCompBtn = document.getElementById('add-component-btn');
        const totalVolIn = document.getElementById('buffer-total-vol');
        const totalVolUnit = document.getElementById('buffer-total-unit');
        const recipeList = document.getElementById('buffer-recipe-list');

        // Prepare Datalist once
        const chemDatalist = document.createElement('datalist');
        chemDatalist.id = 'chem-datalist';
        CONSTANTS.chemicals.sort((a,b)=>a.name.localeCompare(b.name)).forEach(c => {
             const opt = document.createElement('option');
             opt.value = c.name;
             opt.dataset.mw = c.mw;
             chemDatalist.appendChild(opt);
        });
        document.body.appendChild(chemDatalist);

        function createBufferRow(){
            const div = document.createElement('div');
            div.className = "grid grid-cols-1 md:grid-cols-[2fr,minmax(7rem,auto),1fr,1fr,auto,auto] gap-3 items-end p-3 border border-gray-100 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-slate-700/50";

            // Unique ID for MW field to link update logic if needed
            const rowId = Math.random().toString(36).substr(2,9);

            div.innerHTML = `
                <div>
                   <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Component</label>
                   <div class="flex gap-1">
                       <input type="text" list="chem-datalist" class="comp-name w-full p-2 border rounded bg-white text-slate-900 dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-sm dark:text-slate-100" placeholder="Search or type...">
                       <button class="comp-search text-xs bg-indigo-50 dark:bg-slate-700 border border-indigo-200 dark:border-slate-600 rounded px-2 hover:bg-indigo-100 dark:hover:bg-slate-600 dark:text-slate-100" title="Fetch MW from PubChem">üîç</button>
                   </div>
                </div>
                <div class="min-w-[6rem]">
                   <div class="flex justify-between items-center mb-1">
                        <label class="block text-xs text-gray-500 dark:text-gray-400 label-mw">MW (g/mol)</label>
                        <div class="flex items-center gap-1">
                            <input type="checkbox" class="comp-is-liquid" title="Use liquid stock solution?" id="chk-${rowId}">
                            <label for="chk-${rowId}" class="text-[10px] text-indigo-500 dark:text-indigo-400 cursor-pointer" title="Liquid Stock Solution">Liq</label>
                        </div>
                   </div>
                   <div class="flex gap-1">
                       <input type="number" step="0.01" class="comp-mw w-full p-2 border rounded bg-white text-slate-900 dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-sm dark:text-slate-100" placeholder="0.00">
                       <select class="comp-stock-unit hidden w-16 p-1 border rounded bg-gray-50 dark:bg-slate-800 border-gray-300 dark:border-gray-600 text-xs text-slate-900 dark:text-slate-100">
                           <option value="M">M</option>
                           <option value="mM">mM</option>
                           <option value="%">%</option>
                           <option value="x">x</option>
                       </select>
                   </div>
                </div>
                <div class="w-20">
                   <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">+H‚ÇÇO (n)</label>
                   <input type="number" step="0.5" min="0" value="0" class="comp-hydro w-full p-2 border rounded bg-white text-slate-900 dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-sm dark:text-slate-100">
                </div>
                <div>
                   <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Conc</label>
                   <input type="number" step="any" class="comp-conc w-full p-2 border rounded bg-white text-slate-900 dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-sm dark:text-slate-100">
                </div>
                <div class="w-24">
                   <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Unit</label>
                   <select class="comp-unit w-full p-2 border rounded bg-white text-slate-900 dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-sm dark:text-slate-100">
                      <option value="mM" selected>mM</option>
                      <option value="M">M</option>
                      <option value="%">% (w/v)</option>
                   </select>
                </div>
                <button class="remove-row text-red-500 hover:text-red-700 p-2 mb-1" title="Remove">‚úï</button>
            `;

            // Events
            const nameInput = div.querySelector('.comp-name');
            const mwInput = div.querySelector('.comp-mw');
            const searchBtn = div.querySelector('.comp-search');
            const isLiquidChk = div.querySelector('.comp-is-liquid');
            const mwLabel = div.querySelector('.label-mw');
            const hydroInput = div.querySelector('.comp-hydro');
            const stockUnitSel = div.querySelector('.comp-stock-unit');

            // Toggle Liquid Mode
            isLiquidChk.addEventListener('change', () => {
                if(isLiquidChk.checked){
                    mwLabel.textContent = "Stock Conc";
                    mwInput.placeholder = "e.g. 5";
                    stockUnitSel.classList.remove('hidden');
                    hydroInput.disabled = true;
                    hydroInput.parentElement.classList.add('opacity-50');
                } else {
                    mwLabel.textContent = "MW (g/mol)";
                    mwInput.placeholder = "0.00";
                    stockUnitSel.classList.add('hidden');
                    hydroInput.disabled = false;
                    hydroInput.parentElement.classList.remove('opacity-50');
                }
                updateRecipe();
            });

            // 1. Datalist selection & Fuzzy Search updates MW
            nameInput.addEventListener('input', (e) => {
                const val = e.target.value;
                const valLower = val.toLowerCase();

                // 1. Try exact match first
                let match = CONSTANTS.chemicals.find(c => c.name === val);

                // 2. Try fuzzy / synonym match if no exact match
                if (!match && val.length > 1) {
                     match = CONSTANTS.chemicals.find(c => {
                         if (c.name.toLowerCase() === valLower) return true;
                         if (c.synonyms && c.synonyms.some(s => s.toLowerCase() === valLower)) return true;
                         return false;
                     });
                }

                if(match) {
                    mwInput.value = match.mw;
                    updateRecipe();
                }
            });

            // Handle "Enter" on name input to trigger fetch if no match
            nameInput.addEventListener('keydown', (e) => {
                if(e.key === 'Enter'){
                    const val = nameInput.value;
                    const match = CONSTANTS.chemicals.find(c => c.name.toLowerCase() === val.toLowerCase() || (c.synonyms && c.synonyms.some(s => s.toLowerCase() === val.toLowerCase())));
                    if(!match) {
                        searchBtn.click(); // Trigger fetch
                    } else {
                        // Found locally, maybe update name to canonical if needed
                        nameInput.value = match.name;
                        mwInput.value = match.mw;
                        updateRecipe();
                    }
                }
            });

            // 2. PubChem Fetch
            searchBtn.addEventListener('click', async () => {
                 const name = nameInput.value.trim();
                 if(!name) return;
                 const originalText = searchBtn.textContent;
                 searchBtn.textContent = '‚è≥';
                 searchBtn.disabled = true;
                 try {
                     const resp = await fetch(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(name)}/property/MolecularWeight/JSON`);
                     if(!resp.ok) {
                         if(resp.status === 404) throw new Error('Molecule not found');
                         throw new Error(`API Error (${resp.status})`);
                     }
                     const data = await resp.json();
                     if(data.PropertyTable && data.PropertyTable.Properties.length > 0){
                         const mw = data.PropertyTable.Properties[0].MolecularWeight;
                         mwInput.value = mw;
                         // If we found a MW, ensure we are in Solid mode (or just update the field, user can switch)
                         // But if user was in Liq mode, this MW is "Stock Conc" which is wrong.
                         // So force Solid mode?
                         if(isLiquidChk.checked) {
                             isLiquidChk.checked = false;
                             isLiquidChk.dispatchEvent(new Event('change'));
                         }
                         updateRecipe();
                         searchBtn.textContent = '‚úÖ';
                         setTimeout(() => searchBtn.textContent = originalText, 1500);
                     } else {
                         throw new Error('No properties found');
                     }
                 } catch(err) {
                     console.error(err);
                     searchBtn.textContent = '‚ùå';
                     searchBtn.title = err.message;
                     setTimeout(() => {
                         searchBtn.textContent = originalText;
                         searchBtn.title = "Fetch MW from PubChem";
                     }, 1500);
                     // Optional: Alert user only if explicit click?
                     // alert('PubChem Error: ' + err.message);
                 } finally {
                     searchBtn.disabled = false;
                 }
            });

            div.querySelector('.remove-row').addEventListener('click', () => { div.remove(); updateRecipe(); });
            div.querySelectorAll('input, select').forEach(el => el.addEventListener('input', updateRecipe));

            return div;
        }

        function updateRecipe(){
            const volVal = parseFloat(totalVolIn.value) || 0;
            const volUnit = totalVolUnit.value;
            const volL = volUnit === 'mL' ? volVal / 1000 : volVal;

            if(volL <= 0) { recipeList.innerHTML = '<li class="text-red-500">Invalid volume.</li>'; return; }

            let html = `<li><strong>Total Volume:</strong> ${volVal} ${volUnit}</li>`;
            let hasComp = false;

            bufferRows.querySelectorAll('div.grid').forEach(row => {
                const name = row.querySelector('.comp-name').value || "Unknown";
                const valInput = parseFloat(row.querySelector('.comp-mw').value) || 0; // MW or Stock Conc
                const hydroN = parseFloat(row.querySelector('.comp-hydro').value) || 0;
                const conc = parseFloat(row.querySelector('.comp-conc').value);
                const unit = row.querySelector('.comp-unit').value;
                const isLiquid = row.querySelector('.comp-is-liquid').checked;

                if(valInput > 0 && conc > 0){
                    hasComp = true;

                    if(isLiquid){
                        // Liquid Stock Logic
                        const stockVal = valInput;
                        const stockUnit = row.querySelector('.comp-stock-unit').value;

                        let volNeededL = 0;
                        let valid = false;

                        // Normalize to base unit (M or %) or simple ratio
                        if (stockUnit === 'M' || stockUnit === 'mM') {
                            const sM = stockUnit === 'M' ? stockVal : stockVal/1000;
                            let tM = 0;
                            if(unit === 'M') tM = conc;
                            else if(unit === 'mM') tM = conc/1000;

                            if(tM > 0) {
                                volNeededL = (tM * volL) / sM;
                                valid = true;
                            }
                        } else if (stockUnit === '%') {
                            // If Stock is %, target must be % ideally.
                            // Or if target is M, we fail?
                            if (unit === '%') {
                                // C1V1 = C2V2 => V1 = C2V2/C1
                                // 50% * V1 = 5% * 1L => V1 = 0.05 * 1 / 0.5 = 0.1
                                // C is dimensionless ratio here, so just match
                                volNeededL = (conc * volL) / stockVal;
                                valid = true;
                            }
                            // If user puts 100% Acetic Acid and asks for 50 mM.
                            // We can't do it without density/MW.
                        } else if (stockUnit === 'x') {
                            // e.g. 10x stock. Target is usually 1x?
                            // If unit is 'x', we assume target is 1x (implied) OR
                            // the user enters '1' in conc and selects 'x' unit?
                            // Actually, let's assume if Stock is 'x', the Conc Input is the target 'x'.
                            // e.g. Stock 10x. Target 1x.
                            // If user selected 'M' or 'mM' for target, we can't convert.
                            // But usually 'x' implies "Concentration Factor".
                            // Let's support: If stock is '10' (unit x), and user wants '1' (unit M? No).
                            // User should probably select 'x' as target unit too? My target units are M, mM, %.
                            // Maybe user puts '1' (unit M) but means 1x?
                            // Let's strictly handle M/mM and % pairs.
                        }

                        if(valid){
                            let volDisplay = '';
                            if(volNeededL < 0.000001) volDisplay = (volNeededL * 1e9).toFixed(1) + ' nL';
                            else if(volNeededL < 0.001) volDisplay = (volNeededL * 1e6).toFixed(1) + ' ŒºL';
                            else if(volNeededL < 1) volDisplay = (volNeededL * 1000).toFixed(1) + ' mL';
                            else volDisplay = volNeededL.toFixed(3) + ' L';

                            html += `<li class="flex justify-between border-b border-dotted border-gray-300 dark:border-gray-700 pb-1">
                                <span>${name} (Target: ${conc} ${unit})</span>
                                <span class="font-mono font-bold text-indigo-600 dark:text-indigo-400">Add ${volDisplay} <span class="text-[10px] text-gray-400 font-normal">of ${stockVal}${stockUnit}</span></span>
                            </li>`;
                        } else {
                            html += `<li class="text-red-400 text-xs">Cannot calc volume for ${name}. Ensure Stock/Target units match type (M/mM or %).</li>`;
                        }

                    } else {
                        // Solid Logic
                        const baseMw = valInput;
                        const effMw = baseMw + (hydroN * 18.015);
                        let massG = 0;

                        if(unit === 'M') {
                            massG = conc * volL * effMw;
                        } else if (unit === 'mM') {
                            massG = (conc / 1000) * volL * effMw;
                        } else if (unit === '%') {
                            const volmL = volL * 1000;
                            massG = (conc / 100) * volmL;
                        }

                        const hydroNote = hydroN > 0 ? ` (+${hydroN} H‚ÇÇO, MW ${effMw.toFixed(2)})` : '';
                        const massDisp = massG < 1 ? (massG*1000).toFixed(1)+' mg' : massG.toFixed(3)+' g';

                        html += `<li class="flex justify-between border-b border-dotted border-gray-300 dark:border-gray-700 pb-1">
                            <span>${name} (${conc} ${unit})${hydroNote}</span>
                            <span class="font-mono font-bold">${massDisp}</span>
                        </li>`;
                    }
                }
            });

            if(!hasComp) html += '<li class="italic text-gray-400">Add components above.</li>';
            else html += `<li class="mt-2 text-xs text-gray-500">Fill to ${volVal} ${volUnit} with water.</li>`;

            recipeList.innerHTML = html;
        }

        addCompBtn.addEventListener('click', () => { bufferRows.appendChild(createBufferRow()); });
        totalVolIn.addEventListener('input', updateRecipe);
        totalVolUnit.addEventListener('change', updateRecipe);

        // Print Table Logic
        document.getElementById('btn-print-table').addEventListener('click', () => {
             // Gather data
             const volVal = parseFloat(totalVolIn.value) || 0;
             const volUnit = totalVolUnit.value;

             let rows = [];
             bufferRows.querySelectorAll('div.grid').forEach(row => {
                const name = row.querySelector('.comp-name').value || "Unknown";
                const valInput = parseFloat(row.querySelector('.comp-mw').value) || 0;
                const hydroN = parseFloat(row.querySelector('.comp-hydro').value) || 0;
                const conc = parseFloat(row.querySelector('.comp-conc').value);
                const unit = row.querySelector('.comp-unit').value;
                const isLiquid = row.querySelector('.comp-is-liquid').checked;

                if(valInput > 0 && conc > 0){
                    let amountStr = '';
                    let stockStr = '';
                    let notes = '';

                    // Re-calculate simply for display (logic duplicated from updateRecipe slightly)
                    // We can scrape the recipe list, but cleaner to recalculate or parse.
                    // Let's use the inputs to be precise.

                    const volL = volUnit === 'mL' ? volVal / 1000 : volVal;

                    if(isLiquid){
                         stockStr = valInput + row.querySelector('.comp-stock-unit').value + " (Liq)";
                         // Calculate volume needed
                         const stockVal = valInput;
                         const stockUnit = row.querySelector('.comp-stock-unit').value;
                         let volNeededL = 0;

                         if (stockUnit === 'M' || stockUnit === 'mM') {
                            const sM = stockUnit === 'M' ? stockVal : stockVal/1000;
                            let tM = 0;
                            if(unit === 'M') tM = conc; else if(unit === 'mM') tM = conc/1000;
                            if(tM > 0) volNeededL = (tM * volL) / sM;
                         } else if (stockUnit === '%') {
                             if(unit === '%') volNeededL = (conc * volL) / stockVal;
                         }

                         if(volNeededL < 0.000001) amountStr = (volNeededL * 1e9).toFixed(1) + ' nL';
                         else if(volNeededL < 0.001) amountStr = (volNeededL * 1e6).toFixed(1) + ' ŒºL';
                         else if(volNeededL < 1) amountStr = (volNeededL * 1000).toFixed(1) + ' mL';
                         else amountStr = volNeededL.toFixed(3) + ' L';

                    } else {
                        const baseMw = valInput;
                        const effMw = baseMw + (hydroN * 18.015);
                        stockStr = effMw.toFixed(2) + " g/mol";
                        if(hydroN > 0) notes = `+${hydroN} H‚ÇÇO`;

                        let massG = 0;
                        if(unit === 'M') massG = conc * volL * effMw;
                        else if (unit === 'mM') massG = (conc / 1000) * volL * effMw;
                        else if (unit === '%') massG = (conc / 100) * (volL*1000);

                        amountStr = massG < 1 ? (massG*1000).toFixed(1)+' mg' : massG.toFixed(3)+' g';
                    }

                    rows.push({ name, stockStr, target: `${conc} ${unit}`, amountStr, notes });
                }
             });

             if(rows.length === 0) { alert("Add components first."); return; }

             const win = window.open('', '_blank');
             const d = new Date().toLocaleDateString();

             win.document.write(`
                <html>
                <head>
                    <title>Buffer Recipe - ${d}</title>
                    <style>
                        body { font-family: sans-serif; padding: 2rem; }
                        h1 { margin-bottom: 0.5rem; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f3f4f6; }
                        .footer { margin-top: 2rem; font-style: italic; color: #555; }
                        @media print {
                            .no-print { display: none; }
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Buffer Recipe</h1>
                    <p><strong>Date:</strong> ${d}</p>
                    <p><strong>Final Volume:</strong> ${volVal} ${volUnit}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th>MW / Stock</th>
                                <th>Target Conc</th>
                                <th>Amount to Add</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.map(r => `
                                <tr>
                                    <td>${r.name}</td>
                                    <td>${r.stockStr}</td>
                                    <td>${r.target}</td>
                                    <td><strong>${r.amountStr}</strong></td>
                                    <td>${r.notes}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="footer">
                        <p>Instructions: Add components to approx 80% volume, adjust pH if necessary, then fill to ${volVal} ${volUnit}.</p>
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
             `);
             win.document.close();
        });

        // Export Markdown Logic
        document.getElementById('btn-export-recipe').addEventListener('click', () => {
             const items = recipeList.querySelectorAll('li');
             if(items.length === 0 || (items.length===1 && items[0].classList.contains('italic'))) {
                 alert("Nothing to export.");
                 return;
             }

             let md = `## Buffer Recipe\n\n`;
             items.forEach(li => {
                 const t = li.innerText.replace(/\n/g, ' ').trim();
                 // Naive parsing: just list
                 md += `- ${t}\n`;
             });

             // Copy to clipboard
             navigator.clipboard.writeText(md).then(() => {
                 const btn = document.getElementById('btn-export-recipe');
                 const old = btn.textContent;
                 btn.textContent = "‚úÖ Copied!";
                 setTimeout(() => btn.textContent = old, 2000);
             }).catch(err => {
                 console.error(err);
                 prompt("Copy markdown below:", md);
             });
        });

        // Add one empty row initially
        bufferRows.appendChild(createBufferRow());

        // --- Macromolecule Logic ---
        const pSeq = document.getElementById('macro-prot-seq');
        const pMW = document.getElementById('macro-prot-mw');
        const pBaseMW = document.getElementById('macro-prot-base-mw'); // Hidden base
        const pEps = document.getElementById('macro-prot-eps');
        const pAbsPerc = document.getElementById('macro-prot-abs-percent');
        const pA280 = document.getElementById('macro-prot-a280');
        const pMg = document.getElementById('macro-prot-res-mgml-in');
        const pUm = document.getElementById('macro-prot-res-um');
        // Extinction Buttons
        const btnEpsRed = document.getElementById('btn-eps-red');
        const btnEpsOx = document.getElementById('btn-eps-ox');
        const valEpsRed = document.getElementById('val-eps-red');
        const valEpsOx = document.getElementById('val-eps-ox');
        // Mods Inputs
        const modGlycoN = document.getElementById('mod-glyco-n');
        const modGlycoType = document.getElementById('mod-glyco-type');
        const modGlycoMass = document.getElementById('mod-glyco-mass');
        const modPhosN = document.getElementById('mod-phos-n');
        const modOtherN = document.getElementById('mod-other-n');
        const modOtherMass = document.getElementById('mod-other-mass');
        const modTotalDisplay = document.getElementById('mod-total-display');

        // Helper to count Y/W/C
        function getProteinParams(seq){
             const s = seq.toUpperCase().replace(/[^A-Z]/g,'');
             if(!s) return { mw: 0, epsRed: 0, epsOx: 0, cystines: 0 };

             const AA_MW = (CONSTANTS.aminoAcids) || {};
             let mw = 18.02; // water
             let Y=0, W=0, C=0;
             for(let c of s){
                 mw += (AA_MW[c] || 110.0);
                 if(c==='Y') Y++;
                 if(c==='W') W++;
                 if(c==='C') C++;
             }
             // Reduced: No Disulfides (C remains C-H)
             const epsRed = (W * 5500) + (Y * 1490);
             // Oxidized: Assume all C pairs form S-S. Floor(C/2) * 125 ? Or is the 125 per bond? Yes, 125 M-1 cm-1 per S-S bond.
             // Actually, usually stated as: e(S-S) approx 125, but some sources say 60 per C?
             // Standard: "E(Prot) = N(Tyr)*1490 + N(Trp)*5500 + N(Cystine)*125"
             // Cystine is a pair.
             const nCystine = Math.floor(C / 2);
             const epsOx = epsRed + (nCystine * 125);

             return { mw: mw / 1000, epsRed, epsOx }; // MW in kDa
        }

        // Logic for Mod Mass
        function updateMods(){
             // Base MW should be available
             const base = parseFloat(pBaseMW.value) || 0;
             if(base <= 0) return; // Wait for base

             // Glyco
             const nG = parseFloat(modGlycoN.value) || 0;
             const mG = parseFloat(modGlycoMass.value) || 0;

             // Phos
             const nP = parseFloat(modPhosN.value) || 0;
             const mP = (CONSTANTS.modifications && CONSTANTS.modifications.phosphorylation) ? (CONSTANTS.modifications.phosphorylation/1000) : 0.08;

             // Other
             const nO = parseFloat(modOtherN.value) || 0;
             const mO = parseFloat(modOtherMass.value) || 0;

             const addedMass = (nG * mG) + (nP * mP) + (nO * mO);
             const totalMW = base + addedMass;

             pMW.value = totalMW.toFixed(2);
             modTotalDisplay.textContent = `Mods: +${addedMass.toFixed(2)} kDa`;

             // Trigger updates dependent on MW (Abs 0.1%, uM)
             recalE1();
        }

        // Glyco Type change
        modGlycoType.addEventListener('change', () => {
             const val = modGlycoType.value;
             if(val !== 'custom') {
                 modGlycoMass.value = val;
                 updateMods();
             }
        });

        [modGlycoN, modGlycoMass, modPhosN, modOtherN, modOtherMass].forEach(el => el.addEventListener('input', updateMods));

        function updateProtParams(){
            const vals = getProteinParams(pSeq.value);
            if(vals.mw > 0.02) {
                // Set Base MW
                pBaseMW.value = vals.mw.toFixed(2);

                // Update Extinction Options
                valEpsRed.textContent = vals.epsRed;
                valEpsOx.textContent = vals.epsOx;

                // Store in buttons
                btnEpsRed.dataset.val = vals.epsRed;
                btnEpsOx.dataset.val = vals.epsOx;

                // Default to Reduced if not set? Or use previous logic?
                // Let's set Reduced by default if empty
                if(!pEps.value) pEps.value = vals.epsRed;

                // Update Mods (Calculate total MW)
                updateMods();
            }
        }

        btnEpsRed.onclick = () => { if(btnEpsRed.dataset.val) { pEps.value = btnEpsRed.dataset.val; recalE1(); } };
        btnEpsOx.onclick = () => { if(btnEpsOx.dataset.val) { pEps.value = btnEpsOx.dataset.val; recalE1(); } };

        function calcProtConcFromA280(){
            // Driven by A280 input
            const A = parseFloat(pA280.value) || 0;
            const abs1 = parseFloat(pAbsPerc.value);

            // If we have Abs 0.1% (E1%), use it: Conc(mg/ml) = A280 / E1%
            if(abs1 > 0){
                const mgml = A / abs1;
                pMg.value = mgml.toFixed(3);

                // Calc uM from mg/ml and MW
                const mwKDa = parseFloat(pMW.value);
                if(mwKDa > 0){
                    // uM = (mg/ml / MW_kDa) * 1000 ? No.
                    // mg/mL = g/L. M = (g/L) / MW_Da. uM = M * 1e6 = (g/L / MW_Da) * 1e6.
                    // uM = (mgml / (mwKDa*1000)) * 1e6 = mgml / mwKDa * 1000.
                    const um = (mgml / mwKDa) * 1000;
                    pUm.textContent = um.toFixed(2);
                }
            }
        }

        function calcProtConcFromMg(){
             // Driven by Conc(mg/ml) input
             const mgml = parseFloat(pMg.value) || 0;
             const abs1 = parseFloat(pAbsPerc.value);
             const mwKDa = parseFloat(pMW.value);

             // Update A280
             if(abs1 > 0){
                 pA280.value = (mgml * abs1).toFixed(3);
             }

             // Update uM
             if(mwKDa > 0){
                 const um = (mgml / mwKDa) * 1000;
                 pUm.textContent = um.toFixed(2);
             }
        }

        pSeq.addEventListener('input', updateProtParams);
        pA280.addEventListener('input', calcProtConcFromA280);
        pMg.addEventListener('input', calcProtConcFromMg);

        // Recalculate Abs1% if Eps or MW is edited manually
        function recalE1(){
             const e = parseFloat(pEps.value);
             const mw = parseFloat(pMW.value);
             if(e && mw) pAbsPerc.value = (e / (mw*1000)).toFixed(3);
             calcProtConcFromA280();
        }
        pEps.addEventListener('input', recalE1);
        pMW.addEventListener('input', recalE1);
        // If E1% changed manually, just recalc conc
        pAbsPerc.addEventListener('input', calcProtConcFromA280);


        // NA Logic
        const nType = document.getElementById('macro-na-type');
        const nSeq = document.getElementById('macro-na-seq');
        const nLen = document.getElementById('macro-na-len');
        const nMww = document.getElementById('macro-na-mw');
        const nConc = document.getElementById('macro-na-ngul');
        const nRes = document.getElementById('macro-na-nm');
        const nTm = document.getElementById('macro-na-tm');
        const nTmBox = document.getElementById('macro-na-tm-box');

        function calcNaParams(){
            const type = nType.value;
            const seq = nSeq.value.toUpperCase().replace(/[^A-Z]/g,'');

            let len = parseInt(nLen.value) || 0;
            if(seq.length > 0) {
                len = seq.length;
                nLen.value = len; // Auto-update length if seq present
            }

            // MW Calculation
            let mw = 0;
            if(len > 0){
                if(type === 'dsDNA') mw = len * 650; // approx 650 Da/bp (Na salt)
                else if (type === 'ssDNA') mw = len * 330;
                else if (type === 'ssRNA') mw = len * 340;
            }
            nMww.value = mw > 0 ? mw.toFixed(0) : '';

            // Conc: ng/uL -> nM
            const concNg = parseFloat(nConc.value) || 0;
            if(mw > 0 && concNg > 0){
                const nm = (concNg * 1e6) / mw;
                nRes.value = nm.toFixed(1);
            } else {
                nRes.value = '';
            }

            // Tm Calc (Only if sequence)
            if(seq.length > 0 && (type === 'dsDNA' || type === 'ssDNA')){
                nTmBox.classList.remove('hidden');
                // Basic rules
                let tm = 0;
                const A = (seq.match(/A/g)||[]).length;
                const T = (seq.match(/T/g)||[]).length;
                const G = (seq.match(/G/g)||[]).length;
                const C = (seq.match(/C/g)||[]).length;

                if(len < 14){
                    // Wallace rule: 2(A+T) + 4(G+C)
                    tm = 2*(A+T) + 4*(G+C);
                } else {
                    // Approximate: 64.9 + 41*(G+C - 16.4)/(A+T+G+C)
                    tm = 64.9 + 41 * (G+C - 16.4)/len;
                }
                nTm.textContent = tm.toFixed(1);
            } else {
                nTmBox.classList.add('hidden');
            }
        }

        [nType, nSeq, nLen, nConc].forEach(el => el.addEventListener('input', calcNaParams));

        // --- Cryo EM Logic ---
        const cPix = document.getElementById('cryo-pix');
        const cBox = document.getElementById('cryo-box');
        const cBin = document.getElementById('cryo-bin');
        const cFcBox = document.getElementById('cryo-fc-box'); // Fourier Crop Box
        const cTargetRes = document.getElementById('cryo-target-res');
        const cSuggestion = document.getElementById('cryo-box-suggestion');

        function isGoodBox(n) {
             // Must be even. Prefer factors 2, 3, 5, 7.
             if(n % 2 !== 0) return false;
             let x = n;
             [2,3,5,7].forEach(f => { while(x % f === 0) x /= f; });
             return x === 1;
        }

        function findNextGoodBox(start) {
            let n = Math.ceil(start);
            if(n%2 !== 0) n++;
            while(!isGoodBox(n)) n+=2;
            return n;
        }

        function updateCryo(){
            const pix = parseFloat(cPix.value) || 0;
            const box = parseFloat(cBox.value) || 0;
            let bin = parseFloat(cBin.value) || 1;

            // Fourier Crop Logic
            // If FC Box is set, it overrides Binning displayed (effective binning)
            // Bin = Box / FC_Box
            // But user might set Bin explicitly.
            // Let's assume FC Box drives binning if FC Box was the last edited?
            // Or simpler: Calculate Binned values based on inputs.

            const fcBox = parseFloat(cFcBox.value);

            // Raw Stats
            document.getElementById('cryo-res-pix-raw').textContent = pix ? pix.toFixed(3) : '--';
            document.getElementById('cryo-res-nyq-raw').textContent = pix ? (2*pix).toFixed(2) + ' √Ö' : '--';
            document.getElementById('cryo-res-box-raw').textContent = box ? box : '--';
            document.getElementById('cryo-res-phys-raw').textContent = (pix && box) ? (pix*box).toFixed(1) + ' √Ö' : '--';

            // Effective Binning
            let effBin = bin;
            let effBox = box / bin;

            if(fcBox && box){
                // If user entered FC Box, effective binning changes
                effBox = fcBox;
                effBin = box / fcBox;
                // Update Bin input to reflect this relationship?
                // cBin.value = effBin.toFixed(4); // Maybe annoying if typing
            }

            if(pix > 0 && effBox > 0){
                const bPix = pix * effBin;
                document.getElementById('cryo-res-pix-bin').textContent = bPix.toFixed(3);
                document.getElementById('cryo-res-nyq-bin').textContent = (2*bPix).toFixed(2) + ' √Ö';
                document.getElementById('cryo-res-box-bin').textContent = effBox.toFixed(1);
                document.getElementById('cryo-res-phys-bin').textContent = (bPix*effBox).toFixed(1) + ' √Ö';
            }

            // Suggestion
            if(fcBox && !isGoodBox(fcBox)){
                const better = findNextGoodBox(fcBox);
                cSuggestion.textContent = `Tip: ${better} is a better box size (FFT friendly). Click to set.`;
                cSuggestion.onclick = () => { cFcBox.value = better; updateCryo(); };
            } else {
                cSuggestion.textContent = '';
            }
        }

        // Handle Target Res Input -> Calculate needed box
        cTargetRes.addEventListener('input', () => {
             const targetNyq = parseFloat(cTargetRes.value);
             const rawPix = parseFloat(cPix.value);
             const rawBox = parseFloat(cBox.value);

             if(targetNyq && rawPix && rawBox){
                 // Target Nyquist = 2 * NewPixelSize
                 // NewPixelSize = TargetNyq / 2
                 // NewPixelSize = RawPix * (RawBox / NewBox)
                 // TargetNyq/2 = RawPix * RawBox / NewBox
                 // NewBox = (RawPix * RawBox * 2) / TargetNyq

                 let reqBox = (rawPix * rawBox * 2) / targetNyq;
                 // Find nearest good box
                 reqBox = findNextGoodBox(reqBox);

                 // Don't exceed raw box
                 if(reqBox > rawBox) reqBox = rawBox;

                 cFcBox.value = reqBox;
                 updateCryo();
             }
        });

        cFcBox.addEventListener('input', () => {
             // Update Bin to match
             const rawBox = parseFloat(cBox.value);
             const fc = parseFloat(cFcBox.value);
             if(rawBox && fc) cBin.value = (rawBox/fc).toFixed(3);
             updateCryo();
        });

        cBin.addEventListener('input', () => {
             // Update FC Box to match
             const rawBox = parseFloat(cBox.value);
             const b = parseFloat(cBin.value);
             if(rawBox && b) cFcBox.value = Math.round(rawBox/b);
             updateCryo();
        });

        [cPix, cBox].forEach(el => el.addEventListener('input', updateCryo));

        // --- Utilities ---
        // Dilution
        const dM1 = document.getElementById('util-dil-m1');
        const dV1 = document.getElementById('util-dil-v1');
        const dM2 = document.getElementById('util-dil-m2');
        const dV2 = document.getElementById('util-dil-v2');
        const dRes = document.getElementById('util-dil-res');
        const dSchematic = document.getElementById('sd-schematic');

        function calcDilution(){
             const m1 = parseFloat(dM1.value);
             const m2 = parseFloat(dM2.value);
             const v2 = parseFloat(dV2.value);

             if(m1 > 0 && m2 > 0 && v2 > 0){
                 // M1V1 = M2V2 => V1 = (M2*V2)/M1
                 const v1 = (m2 * v2) / m1;
                 dV1.value = v1.toFixed(3);
                 dRes.textContent = `Take ${v1.toFixed(3)} of Stock, add ${(v2-v1).toFixed(3)} diluent.`;
             } else {
                 dV1.value = '';
             }
        }
        [dM1, dM2, dV2].forEach(el => el.addEventListener('input', calcDilution));

        // Molarity - SOLVER
        const mMw = document.getElementById('util-mol-mw');
        const mVol = document.getElementById('util-mol-vol');
        const mConc = document.getElementById('util-mol-conc');
        const mMass = document.getElementById('util-mol-mass');
        const mSolve = document.getElementById('util-mol-solve');

        const mVolUnit = document.getElementById('util-mol-vol-unit');
        const mConcUnit = document.getElementById('util-mol-conc-unit');
        const mMassUnit = document.getElementById('util-mol-mass-unit');

        function updateSolverUI(){
            const target = mSolve.value; // mass, conc, vol, mw
            [mMw, mVol, mConc, mMass].forEach(el => {
                el.readOnly = false;
                el.classList.remove('bg-indigo-50', 'dark:bg-indigo-900/20', 'font-semibold');
                el.classList.add('bg-white', 'dark:bg-slate-900');
            });

            let elTarget;
            if(target === 'mass') elTarget = mMass;
            else if(target === 'conc') elTarget = mConc;
            else if(target === 'vol') elTarget = mVol;
            else if(target === 'mw') elTarget = mMw;

            if(elTarget){
                elTarget.readOnly = true;
                elTarget.classList.remove('bg-white', 'dark:bg-slate-900');
                elTarget.classList.add('bg-indigo-50', 'dark:bg-indigo-900/20', 'font-semibold');
            }
            solveMolarity();
        }

        function solveMolarity(){
            const target = mSolve.value;
            const mw = parseFloat(mMw.value);

            // Unit Multipliers to Base (g, L, M)
            const units = {
                'kg': 1000, 'g': 1, 'mg': 1e-3, 'ug': 1e-6, 'ng': 1e-9, 'pg': 1e-12,
                'L': 1, 'mL': 1e-3, 'uL': 1e-6, 'nL': 1e-9, 'pL': 1e-12,
                'M': 1, 'mM': 1e-3, 'uM': 1e-6, 'nM': 1e-9, 'pM': 1e-12
            };

            const uVol = units[mVolUnit.value];
            const uConc = units[mConcUnit.value];
            const uMass = units[mMassUnit.value];

            // Get base values (or 0)
            const valVol = parseFloat(mVol.value);
            const valConc = parseFloat(mConc.value);
            const valMass = parseFloat(mMass.value);

            // M = mol/L = (g/MW) / L = g / (MW*L)
            // g = M * MW * L

            if(target === 'mass' && mw && valVol && valConc){
                const baseMass = (valConc * uConc) * (valVol * uVol) * mw; // g
                mMass.value = (baseMass / uMass).toPrecision(4);
            } else if (target === 'conc' && valMass && valVol && mw){
                const baseMass = valMass * uMass; // g
                const baseVol = valVol * uVol; // L
                const baseConc = baseMass / (mw * baseVol); // M
                mConc.value = (baseConc / uConc).toPrecision(4);
            } else if (target === 'vol' && valMass && valConc && mw){
                const baseMass = valMass * uMass; // g
                const baseConc = valConc * uConc; // M
                const baseVol = baseMass / (baseConc * mw); // L
                mVol.value = (baseVol / uVol).toPrecision(4);
            } else if (target === 'mw' && valMass && valConc && valVol){
                const baseMass = valMass * uMass;
                const baseConc = valConc * uConc;
                const baseVol = valVol * uVol;
                mMw.value = (baseMass / (baseConc * baseVol)).toFixed(2);
            }
        }

        mSolve.addEventListener('change', updateSolverUI);
        [mMw, mVol, mConc, mMass].forEach(el => el.addEventListener('input', solveMolarity));
        [mVolUnit, mConcUnit, mMassUnit].forEach(el => el.addEventListener('change', solveMolarity));
        updateSolverUI(); // Init

        // Centrifugation
        const cR = document.getElementById('util-cen-r');
        const cRpm = document.getElementById('util-cen-rpm');
        const cRcf = document.getElementById('util-cen-rcf');

        cRpm.addEventListener('input', () => {
            const r = parseFloat(cR.value);
            const rpm = parseFloat(cRpm.value);
            if(r && rpm){
                // g = 1.118e-5 * r * rpm^2
                const g = 1.118e-5 * r * rpm * rpm;
                cRcf.value = Math.round(g);
            }
        });

        cRcf.addEventListener('input', () => {
            const r = parseFloat(cR.value);
            const g = parseFloat(cRcf.value);
            if(r && g){
                 // rpm = sqrt( g / (1.118e-5 * r) )
                 const rpm = Math.sqrt( g / (1.118e-5 * r) );
                 cRpm.value = Math.round(rpm);
            }
        });

        // K-Factor
        const cRmin = document.getElementById('cen-rmin');
        const cRmax = document.getElementById('cen-rmax');
        const cK = document.getElementById('cen-k');

        function calcK(){
            const rpm = parseFloat(cRpm.value);
            const min = parseFloat(cRmin.value);
            const max = parseFloat(cRmax.value);

            if(rpm && min && max && max > min){
                // k = 2.53e11 * ln(max/min) / rpm^2
                const k = (2.53e11 * Math.log(max/min)) / (rpm * rpm);
                cK.textContent = Math.round(k);
            } else {
                cK.textContent = "--";
            }
        }
        [cRmin, cRmax, cRpm].forEach(el => el.addEventListener('input', calcK));

        // --- MASTER MIX LOGIC ---
        const mmRows = document.getElementById('mm-rows');
        const mmAdd = document.getElementById('mm-add-btn');
        const mmResult = document.getElementById('mm-result');
        const inputsMM = ['mm-vol', 'mm-n', 'mm-excess', 'mm-dead'];

        function createMMRow(name='Reagent', vol=1){
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center";
            div.innerHTML = `
                <input type="text" value="${name}" class="mm-name flex-1 p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-xs text-slate-900 dark:text-slate-100" placeholder="Name">
                <input type="number" value="${vol}" step="any" class="mm-one-vol w-20 p-2 border rounded bg-white dark:bg-slate-900 border-gray-300 dark:border-gray-600 text-xs text-right text-slate-900 dark:text-slate-100" placeholder="1x">
                <span class="text-xs text-gray-400">ŒºL</span>
                <button class="text-red-400 hover:text-red-600 px-2">√ó</button>
            `;
            div.querySelector('button').onclick = () => { div.remove(); calcMM(); };
            div.querySelectorAll('input').forEach(i => i.addEventListener('input', calcMM));
            return div;
        }

        function calcMM(){
            const N = parseFloat(document.getElementById('mm-n').value) || 1;
            const exc = parseFloat(document.getElementById('mm-excess').value) || 0;
            const dead = parseFloat(document.getElementById('mm-dead').value) || 0;
            const targetVol = parseFloat(document.getElementById('mm-vol').value) || 0;

            // Calculate Multiplier (N + excess)
            const totalRxns = N * (1 + exc/100);
            document.getElementById('mm-total-n').textContent = totalRxns.toFixed(1);

            let currentVol = 0;
            let html = '';

            // Calculate reagents
            mmRows.querySelectorAll('div.flex').forEach(row => {
                const name = row.querySelector('.mm-name').value;
                const oneVol = parseFloat(row.querySelector('.mm-one-vol').value) || 0;

                // Dead volume is typically added to the TOTAL master mix volume required.
                // But reagents are proportional.
                // Total Vol Required = (TotalRxns * TargetVol) + DeadVol
                // Reagent_Total = (OneVol / TargetVol) * Total_Vol_Required

                const totalVolReq = (targetVol * totalRxns) + dead;

                const totVol = targetVol > 0 ? (oneVol / targetVol) * totalVolReq : 0;

                currentVol += oneVol;

                html += `<li class="flex justify-between border-b border-dotted border-gray-200 dark:border-gray-700">
                            <span>${name}</span>
                            <span>${totVol.toFixed(1)} ŒºL</span>
                         </li>`;
            });

            // Water calculation
            const water = targetVol - currentVol;
            if(water >= 0){
                const totalVolReq = (targetVol * totalRxns) + dead;
                const waterTot = targetVol > 0 ? (water / targetVol) * totalVolReq : 0;

                html += `<li class="flex justify-between text-indigo-600 dark:text-indigo-400 font-semibold">
                            <span>Water</span>
                            <span>${waterTot.toFixed(1)} ŒºL</span>
                         </li>`;
                if(dead > 0) html += `<li class="text-[10px] text-gray-400 text-right mt-1">Includes ${dead}ŒºL dead vol</li>`;
            } else {
                html += `<li class="text-red-500 text-xs">Error: Volumes exceed ${targetVol}ŒºL</li>`;
            }

            mmResult.innerHTML = html;
        }

        inputsMM.forEach(id => document.getElementById(id).addEventListener('input', calcMM));
        mmAdd.addEventListener('click', () => { mmRows.appendChild(createMMRow()); calcMM(); });

        // Init standard MM rows
        mmRows.appendChild(createMMRow("Buffer (10x)", 2));
        mmRows.appendChild(createMMRow("Enzyme", 0.5));
        mmRows.appendChild(createMMRow("Template", 1));
        calcMM();

        // --- AMMONIUM SULFATE LOGIC ---
        const asIds = ['as-vol', 'as-s1', 'as-s2', 'as-temp'];
        asIds.forEach(id => document.getElementById(id).addEventListener('input', calcAS));

        function calcAS(){
            const v = parseFloat(document.getElementById('as-vol').value);
            const s1 = parseFloat(document.getElementById('as-s1').value);
            const s2 = parseFloat(document.getElementById('as-s2').value);
            const temp = document.getElementById('as-temp').value; // 20 or 4

            if(v && !isNaN(s1) && s2){
                // Constants for AmmSulf (Gomori)
                const factor = temp === "20" ? 533 : 516;
                const expansion = temp === "20" ? 0.3 : 0.27; // approx volume correction

                // Target must be < 100
                if(s2 >= 100) { document.getElementById('as-result').textContent = "ERR"; return; }

                const numerator = factor * (s2 - s1);
                const denominator = 100 - (expansion * s2);

                // Result is g/L. Scale to Volume (mL -> L)
                const gPerL = numerator / denominator;
                const gFinal = gPerL * (v / 1000);

                document.getElementById('as-result').textContent = gFinal.toFixed(2);
            }
        }

        // --- SERIAL DILUTION LOGIC ---
        const sdIds = ['sd-factor', 'sd-vol'];
        sdIds.forEach(id => document.getElementById(id).addEventListener('input', calcSD));

        const sdPrepIds = ['sd-prep-stock-c', 'sd-prep-target-c', 'sd-prep-vol'];
        sdPrepIds.forEach(id => document.getElementById(id).addEventListener('input', calcSDPrep));

        function calcSDPrep(){
            const stockC = parseFloat(document.getElementById('sd-prep-stock-c').value);
            const targetC = parseFloat(document.getElementById('sd-prep-target-c').value);
            const targetV = parseFloat(document.getElementById('sd-prep-vol').value);

            if(stockC && targetC && targetV && stockC >= targetC){
                // V_stock = C2 * V2 / C1
                const vStock = (targetC * targetV) / stockC;
                const vBuf = targetV - vStock;

                document.getElementById('sd-prep-res-stock').textContent = vStock.toFixed(1) + ' ŒºL';
                document.getElementById('sd-prep-res-buf').textContent = vBuf.toFixed(1) + ' ŒºL';
            } else {
                document.getElementById('sd-prep-res-stock').textContent = '--';
                document.getElementById('sd-prep-res-buf').textContent = '--';
            }
        }

        function calcSD(){
            const factor = parseFloat(document.getElementById('sd-factor').value);
            const vFinal = parseFloat(document.getElementById('sd-vol').value);

            if(factor > 1 && vFinal > 0){
                // V_transfer = V_final / (Factor - 1)
                const vTrans = vFinal / (factor - 1);
                const vDil = vFinal;

                document.getElementById('sd-diluent').textContent = vFinal + " ŒºL";
                document.getElementById('sd-transfer').textContent = vTrans.toFixed(1) + " ŒºL";

                // Update Schematic
                drawSDSchematic(vFinal, vTrans, factor);
            }
        }

        function drawSDSchematic(vWell, vTrans, factor){
             const container = document.getElementById('sd-schematic');
             container.innerHTML = '';

             // Draw 4 steps
             for(let i=1; i<=4; i++){
                 const tube = document.createElement('div');
                 tube.className = "flex flex-col items-center min-w-[60px]";
                 const isFirst = i===1;

                 // For first tube, show "Start" or calc from prep?
                 // Usually user prepares Well 1, then transfers.

                 tube.innerHTML = `
                    <div class="mb-1 text-[10px] text-gray-500 font-mono">1:${Math.pow(factor, i-1)}</div>
                    <div class="relative w-10 h-16 border-2 border-gray-300 dark:border-gray-600 rounded-b-lg bg-white dark:bg-slate-800 overflow-hidden">
                        <div class="absolute bottom-0 w-full bg-indigo-200 dark:bg-indigo-900/50 transition-all" style="height: 60%"></div>
                    </div>
                    <div class="mt-1 text-[10px] text-center text-gray-400">
                        ${isFirst ? 'Start Mix' : '+'+vTrans.toFixed(1)+'ŒºL'}
                    </div>
                 `;

                 if(!isFirst){
                     const arrow = document.createElement('div');
                     arrow.className = "mb-8 mx-1 text-gray-400 text-xs font-mono relative";
                     arrow.innerHTML = `<span class="absolute -top-3 left-1/2 -translate-x-1/2 whitespace-nowrap">${vTrans.toFixed(0)}ŒºL</span>‚Üí`;
                     container.appendChild(arrow);
                 }

                 container.appendChild(tube);
             }
        }
    }

})();
</script>
